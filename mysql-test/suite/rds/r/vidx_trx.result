CALL mtr.add_suppression("Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT");
SET GLOBAL vidx_disabled = OFF;
SET transaction_isolation = 'READ-COMMITTED';
# 1. Prepare
CREATE TABLE t1 (
id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
v VECTOR(5),
VECTOR INDEX vi(v)
) ENGINE = InnoDB;

# 2. Insert data using transactions
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,10]"));
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,9]"));
BEGIN;
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,8]"));
SAVEPOINT sp1;
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,7]"));
SAVEPOINT sp2;
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,6]"));
ROLLBACK TO SAVEPOINT sp2;
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,5]"));
COMMIT;
BEGIN;
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,4]"));
ROLLBACK;
INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,3]"));

# 3. Validate data
SELECT id, VEC_TOTEXT(v) FROM t1;
id	VEC_TOTEXT(v)
1	[1,2,3,4,10]
2	[1,2,3,4,9]
3	[1,2,3,4,8]
4	[1,2,3,4,7]
6	[1,2,3,4,5]
8	[1,2,3,4,3]
EXPLAIN SELECT id, VEC_TOTEXT(v) FROM t1 FORCE INDEX(PRIMARY) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) LIMIT 5;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	ALL	NULL	NULL	NULL	NULL	8	100.00	Using filesort
SELECT id, VEC_TOTEXT(v) FROM t1 FORCE INDEX(PRIMARY) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) LIMIT 5;
id	VEC_TOTEXT(v)
6	[1,2,3,4,5]
4	[1,2,3,4,7]
8	[1,2,3,4,3]
3	[1,2,3,4,8]
2	[1,2,3,4,9]
EXPLAIN SELECT id, VEC_TOTEXT(v) FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) LIMIT 5;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	NULL	vi	23	NULL	8	100.00	NULL
SELECT id, VEC_TOTEXT(v) FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) LIMIT 5;
id	VEC_TOTEXT(v)
6	[1,2,3,4,5]
4	[1,2,3,4,7]
8	[1,2,3,4,3]
3	[1,2,3,4,8]
2	[1,2,3,4,9]

# 4. Clear
DROP TABLE t1;
SET GLOBAL vidx_disabled = ON;
