CALL mtr.add_suppression("Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT");
SET GLOBAL vidx_disabled = OFF;
SET transaction_isolation = 'READ-COMMITTED';
# 1. Prepare
CREATE TABLE t1 (
id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
a INT NOT NULL,
v VECTOR(5),
INDEX (a),
VECTOR INDEX vi(v)
) ENGINE = InnoDB;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int NOT NULL AUTO_INCREMENT,
  `a` int NOT NULL,
  `v` /*!99999 vector(5) */ varbinary(20) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `a` (`a`)/*!99999 ,
  VECTOR KEY `vi` (`v`) M=6 DISTANCE=EUCLIDEAN */
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci

# 2. Insert 100 rows
INSERT INTO t1(a, v) SELECT 1, VEC_FROMTEXT(CONCAT('[', RAND(), ',', RAND(), ',', RAND(), ',', RAND(), ',', RAND(), ']'));

# 3. Delete
DELETE FROM t1 WHERE id % 3 = 0;

# 4. Update
UPDATE t1 SET v = (SELECT VEC_FROMTEXT(CONCAT('[', RAND(), ',', RAND(), ',', RAND(), ',', RAND(), ',', RAND(), ']'))) WHERE id % 3 = 1;

# 5. Select
SELECT COUNT(*) FROM t1;
COUNT(*)
67
# expect to use vector index scan
EXPLAIN SELECT * FROM t1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 16;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	NULL	vi	23	NULL	67	100.00	NULL
EXPLAIN SELECT * FROM t1 WHERE id>1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 16;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	PRIMARY	vi	23	NULL	67	100.00	Using where
EXPLAIN SELECT * FROM t1 WHERE a=1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 16;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	a	vi	23	NULL	67	100.00	Using where
EXPLAIN SELECT VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) AS distance FROM t1 ORDER BY distance limit 16;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	NULL	vi	23	NULL	67	100.00	NULL
# expect to use JT_ALL
EXPLAIN SELECT * FROM t1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 17;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	ALL	NULL	NULL	NULL	NULL	67	100.00	Using filesort
EXPLAIN SELECT * FROM t1 WHERE id>1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 17;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	ALL	PRIMARY	NULL	NULL	NULL	67	100.00	Using where; Using filesort
EXPLAIN SELECT * FROM t1 WHERE a=1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 17;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	ALL	a	NULL	NULL	NULL	67	100.00	Using where; Using filesort
EXPLAIN SELECT VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) AS distance FROM t1 ORDER BY distance limit 17;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	ALL	NULL	NULL	NULL	NULL	67	100.00	Using filesort
# expect to use SK range
EXPLAIN SELECT * FROM t1 WHERE a>1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 1;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	range	a	a	4	NULL	1	100.00	Using index condition; Using filesort
# FORCE INDEX
EXPLAIN SELECT * FROM t1 FORCE INDEX(PRIMARY) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 16;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	ALL	NULL	NULL	NULL	NULL	67	100.00	Using filesort
EXPLAIN SELECT * FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]"));
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	NULL	vi	23	NULL	67	100.00	NULL
EXPLAIN SELECT * FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 100;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	NULL	vi	23	NULL	67	100.00	NULL
# select using VIEW
CREATE VIEW `view1` AS SELECT * FROM t1;
SELECT id, VEC_TOTEXT(v) FROM `view1` ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) limit 1;
SELECT id, VEC_TOTEXT(v) FROM `view1` ORDER BY VEC_DISTANCE_EUCLIDEAN(VEC_FROMTEXT("[1,2,3,4,5]"), v) limit 1;
DROP VIEW `view1`;

# 6. Select using prepare stmt
PREPARE stmt FROM 'SELECT id FROM t1 ORDER BY vec_distance_euclidean(v, ?) LIMIT ?';
SET @vec = VEC_FROMTEXT("[1,2,3,4,5]");
SET @limit = 10;
EXECUTE stmt USING @vec, @limit;
SET @vec = VEC_FROMTEXT("[1,2,3,4]");
EXECUTE stmt USING @vec, @limit;
ERROR HY000: Incorrect arguments to VEC_DISTANCE_EUCLIDEAN

# 7. Select using distance with different objects
# numeric
SELECT * FROM t1 FORCE INDEX(PRIMARY) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, 1) limit 1;
ERROR HY000: Incorrect arguments to VEC_DISTANCE_EUCLIDEAN
SELECT * FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, 1) limit 1;
ERROR HY000: Incorrect arguments to VEC_DISTANCE_EUCLIDEAN
SELECT * FROM t1 FORCE INDEX(PRIMARY) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, 1.1) limit 1;
ERROR HY000: Incorrect arguments to VEC_DISTANCE_EUCLIDEAN
SELECT * FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, 1.1) limit 1;
ERROR HY000: Incorrect arguments to VEC_DISTANCE_EUCLIDEAN
# string with different length
SELECT * FROM t1 FORCE INDEX(PRIMARY) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, "1.1") limit 1;
ERROR HY000: Incorrect arguments to VEC_DISTANCE_EUCLIDEAN
SELECT * FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, "1.1") limit 1;
ERROR HY000: Incorrect arguments to VEC_DISTANCE_EUCLIDEAN
# string with same length
SELECT * FROM t1 FORCE INDEX(PRIMARY) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0") limit 1;
SELECT * FROM t1 FORCE INDEX(`vi`) ORDER BY VEC_DISTANCE_EUCLIDEAN(v, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0") limit 1;

# 8. Delete all
DELETE FROM t1;

# 9. Clear
DROP TABLE t1;
SET GLOBAL vidx_disabled = ON;
