#############################################
# The syntax and rules for VECTOR FUNCTION  #
#############################################
--source include/have_binlog_format_mixed_or_row.inc

SET GLOBAL vidx_disabled = OFF;
SET transaction_isolation = 'READ-COMMITTED';

--echo # 1. SUPPORT about VECTOR functions
SELECT VECTOR_DIM(VEC_FROMTEXT("[1,2,3,4,5]"));
SELECT VEC_TOTEXT(x'e360d63ebe554f3fcdbc523f4522193f5236083d');
SELECT VEC_TOTEXT("abcd");
SELECT VEC_TOTEXT(VEC_FROMTEXT("[1,2,3,4,5]"));
SELECT VEC_DISTANCE_EUCLIDEAN(VEC_FROMTEXT("[1,2,3,4,5]"), VEC_FROMTEXT("[1,2,3,4,5]"));
SELECT VEC_DISTANCE_EUCLIDEAN(VEC_FROMTEXT("[1,2,3,4,5]"), VEC_FROMTEXT("[1,2,3,4,5.1]"));
SELECT VEC_DISTANCE_COSINE(VEC_FROMTEXT("[1,2,3,4,5]"), VEC_FROMTEXT("[1,2,3,4,5]"));
SELECT VEC_DISTANCE_COSINE(VEC_FROMTEXT("[1,2,3,4,5]"), VEC_FROMTEXT("[1,2,3,4,5.1]"));

--echo # NULL, empty vector is allowed in VEC_TOTEXT and VECTOR_DIM
SELECT VEC_TOTEXT(x'');
SELECT VEC_TOTEXT(NULL);

SELECT VECTOR_DIM(x'');
SELECT VECTOR_DIM(NULL);

--echo # NULL vector is allowed in VEC_FROMTEXT
SELECT VEC_FROMTEXT(NULL);

--echo
--echo # 3. NONSUPPORT about VECTOR functions
--echo # The length of arguments should be able to converted to a vector dimension
--error ER_VECTOR_BINARY_FORMAT_INVALID
SELECT VEC_TOTEXT("abc");

--echo # Invalid binary format
--error ER_TO_VECTOR_CONVERSION
SELECT VEC_FROMTEXT("1,2,3,4,5]");
--error ER_TO_VECTOR_CONVERSION
SELECT VEC_FROMTEXT("");

--echo # The number of arguments is not correct
--error ER_WRONG_PARAMCOUNT_TO_NATIVE_FCT
SELECT VEC_TOTEXT();

--error ER_WRONG_PARAMCOUNT_TO_NATIVE_FCT
SELECT VECTOR_DIM();
--error ER_WRONG_PARAMCOUNT_TO_NATIVE_FCT
SELECT VECTOR_DIM(VEC_FROMTEXT("[1,2,3,4,5]"), VEC_FROMTEXT("[1,2,3,4,5]"));

--echo # The distance tween two vectors having different dimensions should be NULL
SELECT VEC_DISTANCE_EUCLIDEAN(VEC_FROMTEXT("[1,2,3,4,5]"), VEC_FROMTEXT("[1,2,3,4]"));
SELECT VEC_DISTANCE_EUCLIDEAN(VEC_FROMTEXT("[1,2,3,4,5]"), NULL);
SELECT VEC_DISTANCE_COSINE(VEC_FROMTEXT("[1,2,3,4,5]"), VEC_FROMTEXT("[1,2,3,4,5,6]"));
SELECT VEC_DISTANCE_COSINE(NULL, VEC_FROMTEXT("[1,2,3,4,5,6]"));
SELECT VEC_DISTANCE_COSINE(NULL, NULL);

--echo
--echo # 4. DML using vector functions
CREATE TABLE t1 (
  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  v VECTOR(5)
  );

INSERT INTO t1(v) VALUES (VEC_FROMTEXT("[1,2,3,4,5]"));
INSERT INTO t1(v) VALUES (TO_VECTOR("[1.1,2.1,3.1,4.1,5.1]"));
INSERT INTO t1(v) VALUES (STRING_TO_VECTOR("[1.2,2.2,3.2,4.2,5.2]"));
INSERT INTO t1(v) VALUES (x'e360d63ebe554f3fcdbc523f4522193f5236083d');

SELECT id, VEC_TOTEXT(v) FROM t1;
SELECT VECTOR_DIM(v) FROM t1;
SELECT VEC_TOTEXT(v) FROM t1;
SELECT FROM_VECTOR(v) FROM t1;
SELECT VECTOR_TO_STRING(v) FROM t1;

SELECT id, VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]")) FROM t1;
SELECT id, VEC_DISTANCE_COSINE(v, VEC_FROMTEXT("[1,2,3,4,5]")) FROM t1;

SELECT id FROM t1 ORDER BY VEC_DISTANCE_EUCLIDEAN(v, VEC_FROMTEXT("[1,2,3,4,5]"));

DROP TABLE t1;

SET GLOBAL vidx_disabled = ON;
