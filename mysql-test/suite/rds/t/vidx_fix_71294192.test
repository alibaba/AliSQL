################################################################################
# Bug: aone#71294192 Can't find auxiliary table in dd if DROP vector table     #
#      before its dict_table_t is opened.                                      #
# Fix: 1. Use correct db name to find auxiliary table.                         #
#      2. Remove '__hlindexes__' after the auxiliary table is dropped before   #
#         the table is dropped.                                                #
################################################################################
--source include/have_binlog_format_mixed_or_row.inc

CALL mtr.add_suppression("Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT");
SET GLOBAL vidx_disabled = OFF;
SET transaction_isolation = 'READ-COMMITTED';

--echo # Prepare a vector table in other database.
CREATE DATABASE test2;
CREATE TABLE test2.t1 (
  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  v VECTOR(5),
  VECTOR INDEX vi(v)
  ) ENGINE = InnoDB;

INSERT INTO test2.t1(id, v) SELECT 1, VEC_FROMTEXT(CONCAT('[', RAND(), ',', RAND(), ',', RAND(), ',', RAND(), ',', RAND(), ']'));

--echo # Restart mysqld to ensure the auxiliary table is not opened before dropped.
--source include/restart_mysqld_no_echo.inc

--echo # Before this patch, the DROP will cause a crash.
DROP TABLE test2.t1;
DROP DATABASE test2;

SET GLOBAL vidx_disabled = ON;
