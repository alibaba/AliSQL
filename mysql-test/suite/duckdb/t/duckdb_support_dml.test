--source include/master-slave.inc
--source include/have_binlog_format_mixed.inc
--source include/rpl_connection_master.inc
CREATE TABLE t1 (id INT PRIMARY KEY, col1 INT) ENGINE=DuckDB;
CREATE TABLE t2 (id INT PRIMARY KEY, col1 INT) ENGINE=InnoDB;
CREATE TABLE t3 (id INT PRIMARY KEY, col1 INT) ENGINE=DuckDB;
INSERT INTO t2 VALUES (1, 1), (2, 2), (3, 3);
INSERT INTO t3 VALUES (3, 3);
SET @deault_duckdb_dml_in_batch = @@global.duckdb_dml_in_batch;
SET GLOBAL duckdb_dml_in_batch = 0;
--source include/rpl_connection_slave.inc
SET @deault_duckdb_dml_in_batch = @@global.duckdb_dml_in_batch;
SET GLOBAL duckdb_dml_in_batch = 0;

--echo
--echo 1. Insert Statement
--echo 

--source include/rpl_connection_master.inc
INSERT INTO t1 VALUES (1, 1);
INSERT INTO t1 VALUES (2, 2), (3, 3);
SELECT * FROM t1;

--echo
--echo 2. Update Single Table Statement
--echo

--source include/rpl_connection_master.inc
UPDATE t1 SET col1 = col1 + 1 WHERE id = 1;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
UPDATE t1 SET col1 = 10 WHERE col1 = 6;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
UPDATE t1 SET col1 = col1 + 10;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
UPDATE t1 SET col1 = (SELECT max(col1) FROM t3) WHERE id = 1;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
--error ER_DUCKDB_CLIENT
UPDATE t1 SET col1 = (SELECT max(col1) FROM t2) WHERE id = 1;

--echo
--echo 3. Delete Single Table Statement
--echo

--source include/rpl_connection_master.inc
DELETE FROM t1 WHERE id = 1;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
DELETE FROM t1 WHERE col1 < 13;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
DELETE FROM t1 WHERE id = (SELECT max(col1) FROM t3);
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
--error ER_DUCKDB_CLIENT
DELETE FROM t1 WHERE col1 = (SELECT min(col1) FROM t2);

--source include/rpl_connection_master.inc
DELETE FROM t1;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--echo
--echo 4. INSERT ... SELECT ... Table Statement
--echo

--source include/rpl_connection_master.inc
INSERT INTO t1 SELECT * FROM t2;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
INSERT INTO t1 SELECT id + 3, col1 + 3 FROM t1;
SELECT * FROM t1;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
--error ER_DUCKDB_CLIENT
INSERT INTO t2 SELECT * FROM t1;
--error ER_DUCKDB_CLIENT
INSERT INTO t1 SELECT d2.* FROM t1 d1, t2 d2 WHERE d1.id = d2.id;
DELETE FROM t1;

--echo
--echo 5. Update Multi Table Statement
--echo

--source include/rpl_connection_master.inc
INSERT INTO t1 VALUES (1, 1), (2, 2), (3, 3);
INSERT INTO t3 VALUES (1, 1);
--error ER_DUCKDB_CLIENT
UPDATE t1, t2 SET t1.col1 =1 WHERE t1.id = t2.id;
--error ER_DUCKDB_CLIENT
UPDATE t1, t3 SET t1.col1 =1 WHERE t1.id = t3.id;

--echo
--echo 6. Delete Multi Table Statement
--echo

--source include/rpl_connection_master.inc
--error ER_DUCKDB_CLIENT
DELETE t1, t2 FROM t1, t2 WHERE t1.id = t2.id;
--error ER_DUCKDB_CLIENT
DELETE t1, t3 FROM t1, t3 WHERE t1.id = t3.id;
--error ER_DUCKDB_CLIENT
DELETE t1 FROM t1 INNER JOIN t2 ON t1.id = t2.id;
--error ER_DUCKDB_CLIENT
DELETE t1 FROM t1 INNER JOIN t3 ON t1.id = t3.id;

--echo
--echo 7. INSERT/DELETE/UPDATE in a transaction
--echo

--source include/rpl_connection_master.inc
BEGIN;
DELETE FROM t1;
INSERT INTO t1 VALUES (3, 3), (4, 4);
UPDATE t1 SET col1 = col1 + 10;
DELETE FROM t1 WHERE id = 4;
INSERT INTO t2 VALUES (4, 4);
INSERT INTO t1 SELECT id * 10, col1 * 10 FROM t1;
INSERT INTO t1 VALUES (4, 4);
COMMIT;
SELECT * FROM t1;
SELECT * FROM t2;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;
SELECT * FROM t2;

--echo
--echo 8. Transaction Atomicity
--echo

--source include/rpl_connection_master.inc
BEGIN;
DELETE FROM t1 WHERE id = 3;
DELETE FROM t1 WHERE id = 4;
ROLLBACK;
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
BEGIN;
DELETE FROM t1 WHERE id = 3;
DELETE FROM t1 WHERE id = 4;
COMMIT;
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
BEGIN;
UPDATE t1 SET col1 = 3 WHERE id = 30;
UPDATE t1 SET id = 3 WHERE id = 30;
ROLLBACK;
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
BEGIN;
UPDATE t1 SET col1 = 3 WHERE id = 30;
UPDATE t1 SET id = 3 WHERE id = 30;
COMMIT;
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--echo
--echo 9. Explain
--echo

--source include/rpl_connection_master.inc
DELETE FROM t1;
DELETE FROM t2;
DELETE FROM t3;

EXPLAIN INSERT INTO t1 VALUES (1, 1);
EXPLAIN ANALYZE INSERT INTO t1 VALUES (1, 1);
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
INSERT INTO t1 VALUES (1, 1);
INSERT INTO t2 VALUES (1, 1);

--disable_result_log
EXPLAIN INSERT INTO t1 SELECT id + 1, col1 + 1 FROM t1;
--enable_result_log
--error ER_DUCKDB_CLIENT
EXPLAIN ANALYZE INSERT INTO t1 SELECT id + 1, col1 + 1 FROM t1;

EXPLAIN INSERT INTO t1 SELECT id + 1, col1 + 1 FROM t2;
--disable_result_log
EXPLAIN ANALYZE INSERT INTO t1 SELECT id + 1, col1 + 1 FROM t2;
--enable_result_log
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
EXPLAIN UPDATE t1 SET col1 = 10 WHERE id = 1;
--error ER_DUCKDB_CLIENT
EXPLAIN ANALYZE UPDATE t1 SET col1 = 10 WHERE id = 1;
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--source include/rpl_connection_master.inc
EXPLAIN DELETE FROM t1 WHERE id = 1;
--error ER_DUCKDB_CLIENT
EXPLAIN ANALYZE DELETE FROM t1 WHERE id = 1;
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t1;

--echo
--echo 10. Replace
--echo

# All REPLACE statements involving duckdb tables are not supported.
--error ER_DUCKDB_CLIENT
REPLACE INTO t1 VALUES (1, 1);
--error ER_DUCKDB_CLIENT
REPLACE INTO t1 SELECT * FROM t2;
--error ER_DUCKDB_CLIENT
REPLACE INTO t1 SELECT * FROM t3;
--error ER_DUCKDB_CLIENT
REPLACE INTO t2 SELECT * FROM t1;

--echo
--echo 11. CREATE TABLE AS SELECT
--echo

--error ER_DUCKDB_CLIENT
CREATE TABLE t4 ENGINE=DuckDB SELECT * FROM t1;
--error ER_DUCKDB_CLIENT
CREATE TABLE t4 ENGINE=InnoDB SELECT * FROM t1;
--error ER_DUCKDB_CLIENT
CREATE TABLE t4 ENGINE=DuckDB SELECT * FROM t1, t2;
CREATE TABLE t4 (id INT PRIMARY KEY) ENGINE=DuckDB SELECT id FROM t2;
SHOW CREATE TABLE t4;
DROP TABLE t4;

--source include/rpl_connection_master.inc
DROP TABLE t1;
DROP TABLE t2;
DROP TABLE t3;
SET GLOBAL duckdb_dml_in_batch = @deault_duckdb_dml_in_batch;
--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_dml_in_batch = @deault_duckdb_dml_in_batch;
--source include/rpl_end.inc
