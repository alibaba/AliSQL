--source include/master-slave.inc
--source include/have_binlog_format_row.inc
--source include/have_debug.inc

--echo ###########################################################################
--echo # 0. Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 VARCHAR(20) NOT NULL,
    c1 CHAR(10) DEFAULT 'duckdb',
    c2 DECIMAL(5,2),
    c3 DATETIME,
    c4 TIMESTAMP,
    c5 BLOB,
    PRIMARY KEY(id, c0)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
SHOW CREATE TABLE t1;

--echo ###########################################################################
--echo # 1. Test Crash before DuckDB commit
--echo ###########################################################################
--source include/rpl_connection_slave.inc
STOP REPLICA;

--source include/rpl_connection_master.inc
SET autocommit = 1;
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (1, 'abc', NULL, 1.23, '2020-11-20', NULL, X'e18080ff8a');
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (2, 'd', NULL, NULL, '1998-01-01', '2006-02-28 00:21:11', NULL);
UPDATE t1 SET id=6, c4='2026-03-27 10:00:34' WHERE id=1;
DELETE FROM t1 WHERE id=2;
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (5, 'lmn', 'RSA', 10.5, NULL, '1988-10-01 08:58:25', NULL);

--source include/rpl_connection_slave.inc
SET GLOBAL debug = "+d,crash_before_duckdb_commit";
--source include/expect_crash.inc
--enable_reconnect
START REPLICA;
--source include/wait_until_disconnected.inc

--let $rpl_server_number= 2
--source include/rpl_start_server.inc
--disable_reconnect
START REPLICA;

--let $rpl_diff_statement = SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 2. Test Crash after DuckDB commit
--echo ###########################################################################
--source include/rpl_connection_slave.inc
STOP REPLICA;

--source include/rpl_connection_master.inc
SET autocommit = 1;
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (3, 'efg', 'RSA', 5.2, NULL, '2028-09-09 15:30:34', NULL);
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (4, 'hijk', NULL, 6, '2023-06-07', NULL, X'1a53aa890ee6');
UPDATE t1 SET c1='xxxxx', c2=7.79, c3=NULL, c4='2025-03-25 20:58:23', c5=X'e18080e18080' WHERE id=4;
UPDATE t1 SET c2=8.88 WHERE id=5;
DELETE FROM t1 WHERE id=5;

--source include/rpl_connection_slave.inc
SET GLOBAL debug = "+d,crash_after_duckdb_commit";
--source include/expect_crash.inc
--enable_reconnect
START REPLICA;
--source include/wait_until_disconnected.inc

--let $rpl_server_number= 2
--source include/rpl_start_server.inc
--disable_reconnect
START REPLICA;

--let $rpl_diff_statement = SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 3. Test Crash after DuckDB commit an Insert-only Batch
--echo ###########################################################################
--source include/rpl_connection_slave.inc
STOP REPLICA;

--source include/rpl_connection_master.inc
SET autocommit = 1;
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (5, '25sg', 'RDS', 5.2, NULL, '2028-11-11 15:30:34', X'e18080e18080');
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (6, '0aaaa', NULL, 88.88, '2023-06-07', NULL, X'1a53aa890ee6');
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (7, 'hdnnn', 'MYSQL', 11.11, '2023-10-21', NULL, X'e18080e18080');

--source include/rpl_connection_slave.inc
SET GLOBAL debug = "+d,crash_after_duckdb_commit";
--source include/expect_crash.inc
--enable_reconnect
START REPLICA;
--source include/wait_until_disconnected.inc

--let $rpl_server_number= 2
--source include/rpl_start_server.inc
--disable_reconnect
START REPLICA;

--let $rpl_diff_statement = SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1 ORDER BY id, c0;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 4. Test transactions are not replayed by executing SQL
--echo ###########################################################################
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check DML SQL is not executed
--let $assert_select = duckdb_print_dml
--let $assert_count = 0
--source include/assert_grep.inc

--echo ###########################################################################
--echo # 4. Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/rpl_sync.inc
--source include/rpl_end.inc
