--source include/master-slave.inc
--source include/have_binlog_format_row.inc
--source include/have_debug.inc

--echo ###########################################################################
--echo # Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
SET autocommit = 1;
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    PRIMARY KEY(id)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
SHOW CREATE TABLE t1;

--echo ###########################################################################
--echo # Test slow SELECT query will not block Replication
--echo ###########################################################################
--source include/rpl_connection_slave.inc
SET debug_sync = "wait_duckdb_send_result SIGNAL wait_signal WAIT_FOR resume_signal";
send SELECT * FROM t1;

--source include/rpl_connection_slave1.inc
SET debug_sync = "now WAIT_FOR wait_signal";

--source include/rpl_connection_master.inc
INSERT INTO t1 values (1);

--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--source include/rpl_connection_slave1.inc
SET debug_sync = "now SIGNAL resume_signal";

--source include/rpl_connection_slave.inc
reap;

--echo ###########################################################################
--echo # Test Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/rpl_sync.inc
--source include/rpl_end.inc
