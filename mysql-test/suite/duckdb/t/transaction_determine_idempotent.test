--source include/master-slave.inc
--source include/have_binlog_format_row.inc
--source include/have_debug.inc

--echo ###########################################################################
--echo # 0. Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 INT,
    PRIMARY KEY(id)
) ENGINE=InnoDB;

# Currently, the DuckDB(v1.22) will crash when replay WAL log if we add this line
#INSERT INTO t1 VALUES (1,1),(2,2),(3,3),(4,4);

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
--sorted_result
SELECT * FROM t1;
--source include/stop_slave_sql.inc

--echo ###########################################################################
--echo # 1. The Master executes 4 transactions, make sure the Slave receives all.
--echo ###########################################################################
--source include/rpl_connection_master.inc
BEGIN;
INSERT INTO t1 VALUES (5, 5);
INSERT INTO t1 VALUES (6, 6);
COMMIT;

SET GTID_NEXT = 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2';
BEGIN;
INSERT INTO t1 VALUES (7, 7);
COMMIT;
SET GTID_NEXT = 'AUTOMATIC';

BEGIN;
INSERT INTO t1 VALUES (8, 8);
UPDATE t1 SET id = 9 WHERE id = 5;
COMMIT;

BEGIN;
UPDATE t1 SET id = 10 WHERE id = 6;
UPDATE t1 SET id = 11 WHERE id = 8;
INSERT INTO t1 VALUES (12, 12);
COMMIT;

--let $rpl_only_running_threads=1
--source include/rpl_sync.inc

--echo ###########################################################################
--echo # 2. Let the Slave skip executes the 2nd transaction, and Crash when replay
--echo ###########################################################################
--source include/rpl_connection_slave.inc
SET GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2';
BEGIN;
INSERT INTO t1 VALUES (7, 7);
COMMIT;
SET GTID_NEXT = 'AUTOMATIC';

SET GLOBAL debug="+d,crash_after_duckdb_commit";
--source include/expect_crash.inc
START REPLICA SQL_THREAD;

--enable_reconnect
--source include/wait_until_disconnected.inc

--let $rpl_server_number= 2
--let $rpl_server_parameters= --debug=+d,duckdb_print_dml,duckdb_idempotent_2trx
--source include/rpl_start_server.inc
--disable_reconnect
START REPLICA;

--echo ###########################################################################
--echo # 3. After Crash Recovery, check Data and SQLs send to DuckDB, the 1st and
--echo #    3rd transactions should be replayed idempotently, the 4th transaction
--echo #    should not be replayed idempotently.
--echo ###########################################################################
--source include/rpl_connection_master.inc
--sorted_result
SELECT * FROM t1;

--source include/rpl_connection_slave.inc
--source include/rpl_sync.inc
--sorted_result
SELECT * FROM t1;

--let $grep_file=$MYSQLTEST_VARDIR/log/mysqld.2.err
--let $grep_pattern=duckdb_print_dml: .*
--source include/grep_pattern.inc

--echo ###########################################################################
--echo # 4. The Master executes the 5th transaction, make sure the Slave receives
--echo #    the transaction and then restart the Slave. After restart, the Slave
--echo #    should replay it idempotently, but the Slave should not replay the 6th
--echo #    transaction idempotently.
--echo ###########################################################################
--source include/stop_slave_sql.inc

--source include/rpl_connection_master.inc
# the 5th transaction
BEGIN;
UPDATE t1 SET id = 13 WHERE id = 9;
INSERT INTO t1 VALUES (14, 14);
COMMIT;

--let $rpl_only_running_threads=1
--source include/rpl_sync.inc

--let $rpl_server_number= 2
--let $rpl_server_parameters= --debug=+d,duckdb_print_dml
--source include/rpl_stop_server.inc
--exec rm $MYSQLTEST_VARDIR/log/mysqld.2.err
--source include/rpl_start_server.inc

--echo ###########################################################################
--echo # 5. After restart, the Slaved should replay the 5th transaction idempotently,
--echo #    but should not replay the 6th transaction idempotently.
--echo ###########################################################################
--source include/rpl_connection_slave.inc
START REPLICA;
--source include/rpl_sync.inc

--source include/rpl_connection_master.inc
# the 6th transaction
BEGIN;
UPDATE t1 SET id = 15 WHERE id = 11;
INSERT INTO t1 VALUES (16, 16);
COMMIT;

--sorted_result
SELECT * FROM t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--sorted_result
SELECT * FROM t1;

--let $grep_file=$MYSQLTEST_VARDIR/log/mysqld.2.err
--let $grep_pattern=duckdb_print_dml: .*
--source include/grep_pattern.inc

--echo ###########################################################################
--echo # Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/rpl_sync.inc
--source include/rpl_end.inc
