--source include/master-slave.inc
--source include/have_binlog_format_row.inc
--source include/have_debug.inc

--echo ###########################################################################
--echo # 0. Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 VARCHAR(20) NOT NULL,
    c1 CHAR(10) DEFAULT 'duckdb',
    PRIMARY KEY(id, c0)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
SHOW CREATE TABLE t1;
--source include/stop_slave_sql.inc

--echo ###########################################################################
--echo # 1. Test DDL implicit commit DuckDB batch
--echo ###########################################################################
--source include/rpl_connection_master.inc
SET autocommit = 1;

INSERT INTO t1 (id, c0, c1) VALUES (1, 'abc', 'RDS'), (2, 'd', NULL), (3, 'efg', 'MySQL');
UPDATE t1 SET c1='alisql' WHERE id=3;

# Empty Transaction should not trigger the commit of multi-trx
SET gtid_next = 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:6';
BEGIN;
COMMIT;
SET gtid_next = 'AUTOMATIC';

UPDATE t1 SET id=6 WHERE id=1;
DELETE FROM t1 WHERE id=2;

ALTER TABLE t1 ADD COLUMN c2 DECIMAL(5,2);

INSERT INTO t1 (id, c0, c1, c2) VALUES (4, 'hijk', NULL, 10.5), (5, 'lmn', 'RSA', 7.7);
UPDATE t1 SET c2=8.88 WHERE id=6;
DELETE FROM t1 WHERE id=5;
UPDATE t1 SET c0='mysql' WHERE id=4;

ALTER TABLE t1 ADD COLUMN c3 INT DEFAULT 5;

--let $rpl_only_running_threads=1
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--source include/start_slave_sql.inc

--let $rpl_only_running_threads=0
--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1, c2, c3 FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 2. Test transactions are not replayed by executing SQL
--echo ###########################################################################
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check DML SQL is not executed
--let $assert_select = duckdb_print_dml
--let $assert_count = 0
--source include/assert_grep.inc

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check there are 2 commits due to DDL
--let $assert_select = due to DDL
--let $assert_count = 2
--source include/assert_grep.inc

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check there are 0 commit due to non-Row
--let $assert_select = due to non-Row
--let $assert_count = 0
--source include/assert_grep.inc

--echo ###########################################################################
--echo # 6. Test Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/rpl_sync.inc
--source include/rpl_end.inc
