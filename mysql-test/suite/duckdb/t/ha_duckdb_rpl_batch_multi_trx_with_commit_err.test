--source include/master-slave.inc
--source include/have_binlog_format_row.inc

--echo ###########################################################################
--echo # 0. Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
SET autocommit = 1;
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 VARCHAR(20) NOT NULL,
    c1 CHAR(10) DEFAULT 'duckdb',
    PRIMARY KEY(id, c0)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
CALL dbms_duckdb.query("ALTER TABLE test.t1 ADD PRIMARY KEY (id, c0)");
SHOW CREATE TABLE t1;

--echo ###########################################################################
--echo # 1. Test Slave SQL Thread encountered an error during commit
--echo ###########################################################################
--echo # 1.1 Stop Purge in DuckDB
--source include/rpl_connection_slave1.inc
BEGIN;
INSERT INTO t1 VALUES(7, 'xxxx', 'stop purge');

--echo # 1.2 Let DuckDB have two versions of Row 1
--source include/rpl_connection_master.inc
INSERT INTO t1 (id, c0, c1) VALUES (1, 'abc', NULL);
FLUSH LOGS;

UPDATE t1 SET c1='AliSQL' WHERE id=1;
FLUSH LOGS;

--echo # 1.3 DuckDB fails when committing version 3 of Row 1
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
STOP REPLICA;

--source include/rpl_connection_master.inc
UPDATE t1 SET c1='DuckDB' WHERE id=1;
FLUSH LOGS;

--source include/rpl_connection_slave.inc
CALL mtr.add_suppression("MY-010584");
CALL mtr.add_suppression("MY-010583");
START REPLICA;
--let $slave_sql_errno=1105
--source include/wait_for_slave_sql_to_stop.inc

--echo # 1.4 Resume Purge in DuckDB
--source include/rpl_connection_slave1.inc
ROLLBACK;

--echo # 1.5 Check the result
--source include/rpl_connection_slave.inc
START REPLICA;
--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1 FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 2. Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/rpl_sync.inc
--source include/rpl_end.inc
