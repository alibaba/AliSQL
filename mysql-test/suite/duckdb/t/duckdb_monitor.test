#
# For duckdb monitoring tests
#

# restart to reset status
--source include/restart_mysqld.inc

CREATE TABLE t1(id INT PRIMARY KEY, v VARCHAR(255)) ENGINE=duckdb;
CREATE TABLE t2(id INT PRIMARY KEY, v VARCHAR(255)) ENGINE=duckdb;
CREATE TABLE t3(id INT PRIMARY KEY, v VARCHAR(255)) ENGINE=innodb;

--echo #
--echo # 1) Duckdb related status variables
--echo #

SHOW GLOBAL STATUS LIKE '%duckdb%';

--echo # Com_duckdb_insert/Duckdb_rows_insert
SHOW STATUS LIKE '%duckdb%insert%';
INSERT INTO t1 VALUES (1, 'a'), (2, 'b'), (3, 'c'), (4, 'd'), (5, 'e');
INSERT INTO t2 VALUES (1, 'a'), (2, 'b'), (3, 'c'), (4, 'd'), (5, 'e');
SHOW STATUS LIKE '%duckdb%insert%';

--echo # Com_duckdb_delete/Duckdb_rows_delete
SHOW STATUS LIKE '%duckdb%delete%';
DELETE FROM t1 WHERE id IN (1,2);
SHOW STATUS LIKE '%duckdb%delete%';

--echo # Com_duckdb_update/Duckdb_rows_update
SHOW STATUS LIKE '%duckdb%update%';
UPDATE t1 SET v = 'x' WHERE id IN (3,4);
SHOW STATUS LIKE '%duckdb%update%';

--echo # Com_duckdb_insert_select: insert into duckdb select * from duckdb
SHOW STATUS LIKE '%duckdb%insert%';
INSERT INTO t1 SELECT * FROM t2;
SHOW STATUS LIKE '%duckdb%insert%';

--echo # Duckdb_commit
SHOW STATUS LIKE 'Duckdb_commit';
BEGIN;
INSERT INTO t1 VALUES(6,'f');
COMMIT;
SHOW STATUS LIKE 'Duckdb_commit';

--echo # Duckdb_rollback
SHOW STATUS LIKE 'Duckdb_rollback';
BEGIN;
INSERT INTO t1 VALUES(7,'g');
ROLLBACK;
SHOW STATUS LIKE 'Duckdb_rollback';

--echo # Com_duckdb_explain
SHOW STATUS LIKE 'Com_duckdb_explain';

--disable_result_log
EXPLAIN SELECT * FROM t1;
EXPLAIN UPDATE t1 SET v='x' WHERE id=1;
EXPLAIN DELETE FROM t1 WHERE id=1;
--enable_result_log

SHOW STATUS LIKE 'Com_duckdb_explain';

SHOW GLOBAL STATUS LIKE '%duckdb%';


DROP TABLE t1;
DROP TABLE t2;
DROP TABLE t3;
