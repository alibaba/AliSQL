--source include/master-slave.inc
--source include/have_binlog_format_row.inc
--source include/have_debug.inc

--echo ###########################################################################
--echo # 0. Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
SET autocommit = 1;
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 VARCHAR(20) NOT NULL,
    c1 CHAR(10) DEFAULT 'duckdb',
    PRIMARY KEY(id, c0)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
SHOW CREATE TABLE t1;

--echo ###########################################################################
--echo # 1. Test IO Thread reconnect after the Trx2's GTID Event queued
--echo ###########################################################################
--source include/rpl_connection_slave.inc
STOP REPLICA;

--source include/rpl_connection_master.inc
--echo # 1.1 Execute two Transactions on Master
INSERT INTO t1 (id, c0, c1) VALUES (1, 'abc', NULL), (3, 'efg', 'RSA');
UPDATE t1 SET id=6, c1='AliSQL' WHERE id=1;

--echo # 1.2 Make IO Thread stop after the Trx2's GTID Event queued
--source include/rpl_connection_slave.inc
CALL mtr.add_suppression("MY-013122");
SET GLOBAL debug="+d,stop_when_queue_2nd_query_event";
START REPLICA IO_THREAD;
--let $slave_io_errno=13122
--source include/wait_for_slave_io_to_stop.inc
SET GLOBAL debug="-d,stop_when_queue_2nd_query_event";
START REPLICA;

--echo # 1.3 Check the result
--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1 FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 2. Test IO Thread reconnect before the Trx2's XID Event queued
--echo ###########################################################################
--source include/rpl_connection_slave.inc
STOP REPLICA;

--source include/rpl_connection_master.inc
--echo # 2.1 Execute two Transactions on Master
UPDATE t1 SET c0='yyyyyy' WHERE id=3;

INSERT INTO t1 (id, c0, c1) VALUES (2, 'xxx', 'Duck');

--echo # 2.2 Make IO Thread stop before the Trx2's XID Event queued
--source include/rpl_connection_slave.inc
CALL mtr.add_suppression("MY-013122");
SET GLOBAL debug="+d,stop_when_queue_2nd_xid_event";
START REPLICA IO_THREAD;
--let $slave_io_errno=13122
--source include/wait_for_slave_io_to_stop.inc
SET GLOBAL debug="-d,stop_when_queue_2nd_xid_event";
START REPLICA;

--echo # 2.3 Check the result
--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1 FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 3. Test IO Thread reconnect before the Trx2's Table Map Event queued,
--echo #    and SQL Thread restart after Rotate.
--echo ###########################################################################
--source include/rpl_connection_slave.inc
STOP REPLICA;

--source include/rpl_connection_master.inc
--echo # 3.1 Execute two Transactions on Master
INSERT INTO t1 (id, c0, c1) VALUES (4, 'xxx', 'Duck');
UPDATE t1 SET c0='yyyyyy' WHERE id=4;

--echo # 3.2 Make IO Thread stop before the Trx2's Table Map Event queued
--source include/rpl_connection_slave.inc
CALL mtr.add_suppression("MY-013122");
SET GLOBAL debug="+d,stop_when_queue_2nd_table_map_event";
START REPLICA IO_THREAD;
--let $slave_io_errno=13122
--source include/wait_for_slave_io_to_stop.inc
SET GLOBAL debug="-d,stop_when_queue_2nd_table_map_event";

--echo # 3.3 Make SQL Thread execute the partial Trx2, and then restart SQL Thread
SET GLOBAL debug="+d,debug_sync_before_reader_commit";
START REPLICA SQL_THREAD;
SET debug_sync="now WAIT_FOR commit_signal";
SET debug_sync="now SIGNAL resume_signal";
SET GLOBAL debug="-d,debug_sync_before_reader_commit";
STOP REPLICA SQL_THREAD;
--source include/wait_for_slave_sql_to_stop.inc
START REPLICA;

--echo # 3.4 Check the result
--let $slave_timeout=10
--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1 FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 3. Test Rotate Event will implicit commit the current batch
--echo ###########################################################################
--source include/rpl_connection_slave.inc
SET @old_duckdb_multi_trx_timeout = @@GLOBAL.duckdb_multi_trx_timeout;
SET GLOBAL duckdb_multi_trx_timeout = 1000000;

--echo # 3.1 Execute one Transaction on Master, and then Rotate the Binlog
--source include/rpl_connection_master.inc
INSERT INTO t1 (id, c0, c1) VALUES (4, 'zzzzz', '123456');
FLUSH LOGS;

--echo # 3.2 Check the result
--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1 FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_multi_trx_timeout = @old_duckdb_multi_trx_timeout;

--echo ###########################################################################
--echo # 4. Test transactions are not replayed by executing SQL
--echo ###########################################################################
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check DML SQL is not executed
--let $assert_select = duckdb_print_dml
--let $assert_count = 0
--source include/assert_grep.inc

--echo ###########################################################################
--echo # 5. Test Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/rpl_sync.inc
--source include/rpl_end.inc
