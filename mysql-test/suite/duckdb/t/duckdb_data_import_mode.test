
--echo #
--echo # 1) Prepare
--echo #

CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 VARCHAR(20) NOT NULL,
    c1 CHAR(10) DEFAULT 'duckdb',
    c2 DECIMAL(5,2),
    c3 DATETIME,
    c4 TIMESTAMP,
    c5 BLOB,
    PRIMARY KEY(id, c0)
) ENGINE=DuckDB;

INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES
(1, 'abc', NULL, 1.23, '1997-01-01', NULL, X'e18080ff8a'),
(1, 'd', NULL, 2.34, '1998-01-01', NULL, X'e18080ff8b'),
(2, 'd', NULL, NULL, '1999-01-01', '1999-01-01 12:00:00', NULL),
(2, 'efg', NULL, NULL, '2000-01-01', '2000-01-01 13:00:00', NULL),
(3, 'efg', 'RSA', 5.2, NULL, '2001-01-01 14:00:00', NULL),
(3, 'hijk', 'RSB', 5.2, NULL, '2002-01-01 15:00:00', NULL),
(4, 'hijk', 'RSC', 5.3, NULL, '2003-01-01 16:00:00', NULL),
(4, 'lmn', NULL, 6, '2004-01-01', NULL, X'1a53aa890ee6'),
(5, 'lmn', NULL, 7, '2005-01-01', NULL, X'1a53aa890ee7'),
(5, 'opq', 'RSD', 10.5, NULL, '2006-01-01 17:00:00', NULL);


--echo #
--echo # 2) duckdb_data_import_mode is not settable in transaction.
--echo #
BEGIN;
--error ER_VARIABLE_NOT_SETTABLE_IN_TRANSACTION
SET SESSION duckdb_data_import_mode = ON;
--error ER_VARIABLE_NOT_SETTABLE_IN_TRANSACTION
SET SESSION duckdb_data_import_mode = OFF;
COMMIT;

SET SESSION duckdb_data_import_mode = OFF;
SET SESSION duckdb_data_import_mode = ON;


--echo #
--echo # 3) Update can not be executed when duckdb_data_import_mode is ON.
--echo #
--error ER_DUCKDB_DATA_IMPORT_MODE
UPDATE t1 SET c0 = 'abcc' WHERE id = 1 AND c0 = 'abc';

SET SESSION duckdb_data_import_mode = OFF;
UPDATE t1 SET c0 = 'abcc' WHERE id = 1 AND c0 = 'abc';

--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM t1;


--echo #
--echo # 4) Only delete operations with equality conditions on the primary key
--echo #    are permitted, where the right-hand side is a constant value.
--echo #
SET SESSION duckdb_data_import_mode = ON;
# NOT FULL PK
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE id = 1;
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE c0 = 'abcc';

# NOT PK FIELD
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE c1 = 'abcd';

# TOO MANY FIELDS
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE id = 1 AND c0 = 'abcc' AND c1 = 'abcd';

# FIELD IS SPECIFIED MULTIPLE TIMES
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE id = 1 AND c0 = 'abc' AND c0 = 'dddd';
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE id = 1 AND c0 = 'dddd' AND c0 = 'abc';

# NOT WHERE clause
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1;

# NOT EQUAL VALUE
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE id > 1;
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE 1 = 1;
--error ER_DUCKDB_DATA_IMPORT_MODE
DELETE FROM t1 WHERE id = c0;

# IMPLICIT CONVERSION
CREATE TABLE t2 (id INT KEY, col1 INT) ENGINE = DuckDB;
--error ER_TRUNCATED_WRONG_VALUE
DELETE FROM t1 WHERE id = 'abc';
DROP TABLE t2;


--echo #
--echo # 5) Batch inserts and deletes.
--echo #

BEGIN;

# update (1, 'abcc'), only update no-pk fields.
DELETE FROM t1 WHERE id = 1 AND c0 = 'abcc';
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES
(1, 'abcc', 'duckdb', 9.99, '2025-01-01', '2025-01-01 00:00:00', X'deadbeef');

# update (3, 'efg'), update fields with part of pk.
DELETE FROM t1 WHERE id = 3 AND c0 = 'efg';
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES
(3, 'gfe', 'NEW', 9.99, NULL, '2026-02-02 01:00:00', NULL);

# update (5, 'lmn') update all fields.
DELETE FROM t1 WHERE id = 5 AND c0 = 'lmn';
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES
(6, 'nml', NULL, 77, '2027-03-03', '2027-03-03 02:00:00', X'1a53aa890ee9');

# insert (7, 'rst'), (8, 'uvw')
INSERT INTO t1 VALUES
(7, 'rst', 'duckdb', 1.00, '2028-04-04', '2028-04-04 03:00:00', X'1a53aa890e78'),
(8, 'uvw', NULL, 8.88, NULL, NULL, X'1a53aa890e66');

# delete (2, 'efg'), (4, 'lmn')
DELETE FROM t1 WHERE id = 2 AND c0 = 'efg';
DELETE FROM t1 WHERE c0 = 'lmn' AND id = 4;

--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM t1;

COMMIT;

--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM t1;


--echo #
--echo # 6) Test for variable duckdb_idempotent_data_import_enabled
--echo #
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.1.err
--exec echo "" > $assert_file
SET GLOBAL duckdb_log_options = 'DUCKDB_MULTI_TRX_BATCH_COMMIT,DUCKDB_MULTI_TRX_BATCH_DETAIL,DUCKDB_QUERY,DUCKDB_QUERY_RESULT';
SET SESSION duckdb_data_import_mode = ON;
# INSERT WILL BE DELETE + INSERT.
SET GLOBAL duckdb_idempotent_data_import_enabled = ON;
BEGIN;
INSERT INTO t1 VALUES
(9, 'rst', 'duckdb', 1.00, '2028-04-04', '2028-04-04 03:00:00', X'1a53aa890e78');
COMMIT;

--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM t1;

--let $assert_text = Find delete action in log
--let $assert_select = DELETE FROM `test`.`t1`
--let $assert_count = 1
--source include/assert_grep.inc

--let $assert_text = Find insert action in log
--let $assert_select = INSERT INTO `test`.`t1`
--let $assert_count = 1
--source include/assert_grep.inc

--exec echo "" > $assert_file
# INSERT WILL STILL BE INSERT.
SET GLOBAL duckdb_idempotent_data_import_enabled = OFF;
BEGIN;
INSERT INTO t1 VALUES
(10, 'rst', 'duckdb', 1.00, '2028-04-04', '2028-04-04 03:00:00', X'1a53aa890e78');
COMMIT;

--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM t1;

--let $assert_text = Not find delete action in log
--let $assert_select = DELETE FROM `test`.`t1`
--let $assert_count = 0
--source include/assert_grep.inc

--let $assert_text = Find insert action in log
--let $assert_select = INSERT INTO `test`.`t1`
--let $assert_count = 1
--source include/assert_grep.inc


--echo #
--echo # 7) Cleanup
--echo #
SET GLOBAL duckdb_idempotent_data_import_enabled = default;
SET GLOBAL duckdb_log_options = default;
DROP TABLE t1;
