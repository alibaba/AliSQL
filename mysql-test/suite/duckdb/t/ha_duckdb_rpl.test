--source include/master-slave.inc
--source include/have_debug.inc
--source include/have_binlog_format_row.inc

--echo ###########################################################################
--echo # 0. Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 VARCHAR(20) NOT NULL,
    c1 CHAR(10) DEFAULT 'duckdb',
    c2 DECIMAL(5,2),
    c3 DATETIME,
    c4 TIMESTAMP,
    c5 BLOB,
    PRIMARY KEY(id)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
SHOW CREATE TABLE t1;

--echo ###########################################################################
--echo # 1. Test Insert
--echo ###########################################################################
--source include/rpl_connection_master.inc
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES
(1, 'abc', NULL, 1.23, '2020-11-20', NULL, X'e18080ff8a'),
(2, 'd', NULL, NULL, '1998-01-01', '2006-02-28 00:21:11', NULL),
(3, 'efg', 'RSA', 5.2, NULL, '2028-09-09 15:30:34', NULL),
(4, 'hijk', NULL, 6, '2023-06-07', NULL, X'1a53aa890ee6'),
(5, 'lmn', 'RSA', 10.5, NULL, '1988-10-01 08:58:25', NULL);
CHECKSUM TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1;
CHECKSUM TABLE t1;

--echo ###########################################################################
--echo # 2. Test Update
--echo ###########################################################################

--echo # 2.1 Test with duckdb_update_modified_column_only = ON
--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_update_modified_column_only = ON;

--source include/rpl_connection_master.inc
UPDATE t1 SET c1='xxxxx', c2=7.79, c3=NULL, c4='2025-03-25 20:58:23', c5=X'e18080e18080' WHERE id=4;
UPDATE t1 SET c0='yyyyyy' WHERE id=3;
CHECKSUM TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1;
CHECKSUM TABLE t1;

--echo # 2.2 Test with duckdb_update_modified_column_only = OFF
SET GLOBAL duckdb_update_modified_column_only = OFF;

--source include/rpl_connection_master.inc
UPDATE t1 SET c2=8.88 WHERE id=5;
CHECKSUM TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1;
CHECKSUM TABLE t1;
SET GLOBAL duckdb_update_modified_column_only = default;

--echo # 2.3 Test Update PK's field
--source include/rpl_connection_master.inc
UPDATE t1 SET id=6, c4='2026-03-27 10:00:34' WHERE id=1;
CHECKSUM TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1;
CHECKSUM TABLE t1;
SET GLOBAL duckdb_update_modified_column_only = default;

--echo ###########################################################################
--echo # 3. Test Delete
--echo ###########################################################################
--source include/rpl_connection_master.inc
DELETE FROM t1 WHERE id=2 OR id=5;
CHECKSUM TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--sorted_result
SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1;
CHECKSUM TABLE t1;

--echo ###########################################################################
--echo # 4. Show all generated SQL
--echo ###########################################################################
--let $grep_file=$MYSQLTEST_VARDIR/log/mysqld.2.err
--let $grep_pattern=duckdb_print_dml: .*
--source include/grep_pattern.inc

--echo ###########################################################################
--echo # 5. Test Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/rpl_sync.inc
--source include/rpl_end.inc
