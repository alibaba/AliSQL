--source include/have_debug.inc

--echo #
--echo # datetime type, test insert and SELECT unchanged
--echo #

--let $create_sql = CREATE TABLE t_datetime (a datetime, b datetime, c datetime)
--let $table_name = t_datetime
--let $insert_sql = insert into t_datetime values ('2020-01-01 12:00:00', '1969-01-01 12:00:00', '2020-01-01 12:00:00.001')
--let $select_sql = SELECT a, b, c FROM t_datetime
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

--echo #
--echo # timestampï¼Œtest insert and SELECT unchanged
--echo #

--let $create_sql = CREATE TABLE t_timestamp (a timestamp, b timestamp, c timestamp, d timestamp, e timestamp)
--let $table_name = t_timestamp
--let $insert_sql = INSERT INTO t_timestamp VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1970-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $select_sql = SELECT a, b, c, d, e FROM t_timestamp
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc


--echo #
--echo # Under system timezone, test linux `date` command and mysql `SELECT now()` get the same result
--echo #

--source include/restart_mysqld.inc
SET TIME_ZONE = system;

--let $_TMP_OUT_o= $MYSQLTEST_VARDIR/tmp/_t_os_time_o
--let $_TMP_OUT_n= $MYSQLTEST_VARDIR/tmp/_t_os_time_n

--exec date +"%Y-%m-%d %H:%M:%S" | tr -d '\n' > $_TMP_OUT_o
--exec date -d "+1 minutes" +"%Y-%m-%d %H:%M:%S" | tr -d '\n' > $_TMP_OUT_n

--let $os_time_o = `SELECT LOAD_FILE('$_TMP_OUT_o')`
--let $os_time_n = `SELECT LOAD_FILE('$_TMP_OUT_n')`

SELECT sleep(1);

CREATE TABLE t(a timestamp) ENGINE=duckdb;
INSERT INTO t VALUES (now());

--let $sql=SELECT now() > '$os_time_o' FROM t
--let $ret=`$sql`
--if ($ret != 1) {
--die "[SELECT @should_be_1]" != "1"
}

--let $sql=SELECT count(*) FROM t WHERE a > '$os_time_o'
--let $ret=`$sql`
--if ($ret != 1) {
--die "[SELECT count]" != "1"
}

--let $sql=SELECT now() < '$os_time_n' FROM t
--let $ret=`$sql`
--if ($ret != 1) {
--die "[SELECT @should_be_1]" != "1"
}

--let $sql=SELECT count(*) FROM t WHERE a < '$os_time_n'
--let $ret=`$sql`
--if ($ret != 1) {
--die "[SELECT count]" != "1"
}

--remove_file $_TMP_OUT_o
--remove_file $_TMP_OUT_n
DROP TABLE t;


--echo #
--echo # For unsupported timezone
--echo #

--enable_warnings

CREATE TABLE t_time_zone_unsupported (a timestamp) ENGINE=duckdb;
INSERT INTO t_time_zone_unsupported VALUES (from_unixtime(1740117061));

SET time_zone = '+02:00';
SELECT a FROM t_time_zone_unsupported;

SET time_zone = '+02:30';
SELECT a FROM t_time_zone_unsupported;

SET time_zone = '+03:00';
SELECT a FROM t_time_zone_unsupported;

DROP TABLE t_time_zone_unsupported;


--echo #
--echo # Insert and Select under the same timezone, check duckdb and innodb are the same
--echo #

SET time_zone = 'UTC';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b timestamp(6), c datetime, d datetime(6), e timestamp(6))
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1969-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $config_sql =
--let $select_sql = SELECT a, b, c, d, e FROM t_time_zone
--let $die_on_error=0
--source suite/duckdb/include/check_field_correctness.inc

SET time_zone = 'Europe/Moscow';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b timestamp(6), c datetime, d datetime(6), e timestamp(6))
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1969-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $config_sql =
--let $select_sql = SELECT a, b, c, d, e FROM t_time_zone
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

SET time_zone = system;
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b timestamp(6), c datetime, d datetime(6), e timestamp(6))
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1969-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $config_sql =
--let $select_sql = SELECT a, b, c, d, e FROM t_time_zone
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

SET time_zone = '+10:00';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b timestamp(6), c datetime, d datetime(6), e timestamp(6))
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1969-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $config_sql =
--let $select_sql = SELECT a, b, c, d, e FROM t_time_zone
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

--echo #
--echo # Timezone changed between Insert and Select, check duckdb and innodb are the same
--echo #

--echo # Time zone changed from '+10:00' to '+09:00'
SET time_zone = '+10:00';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b timestamp(6), c datetime, d datetime(6), e timestamp(6))
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1969-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $config_sql = SET time_zone = '+09:00';
--let $select_sql = SELECT a, b, c, d, e FROM t_time_zone
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

--echo # Time zone changed from SYSTEM to 'Europe/Moscow'
SET time_zone = SYSTEM;
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b timestamp(6), c datetime, d datetime(6), e timestamp(6))
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1969-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $config_sql = SET time_zone = 'Europe/Moscow';
--let $select_sql = SELECT a, b, c, d, e FROM t_time_zone
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

--echo # Time zone changed from  '+02:00' to Japan
SET time_zone = '+02:00';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b timestamp(6), c datetime, d datetime(6), e timestamp(6))
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00', '1969-01-01 12:00:00', from_unixtime(1740117061), from_unixtime(1740117061.1234));
--let $config_sql = SET time_zone = Japan;
--let $select_sql = SELECT a, b, c, d, e FROM t_time_zone
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc


--echo #
--echo # Use time colum to do compare with string, check duckdb and innodb are the same
--echo # It test the timezone setting of duckdb connection is the consistent with mysql thd
--echo #

--echo # test1
SET time_zone = '+08:00';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b datetime)
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00');
--let $config_sql =
--let $select_sql = SELECT * FROM t_time_zone WHERE a < '2020-01-01 12:00:01' and a > '2020-01-01 11:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00'
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

--echo # test2
SET time_zone = '+08:00';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b datetime)
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00');
--let $config_sql = SET time_zone = UTC;
--let $select_sql = SELECT * FROM t_time_zone WHERE a < '2020-01-01 04:00:01' and a > '2020-01-01 03:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00'
--let $select_sql = SELECT * FROM t_time_zone
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

--echo # test3
SET time_zone = '+07:00';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b datetime)
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00')
--let $config_sql = SET time_zone = 'MET'
--let $select_sql = SELECT * FROM t_time_zone WHERE a < '2020-01-01 06:00:01' and a > '2020-01-01 05:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00'
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc

--echo # test4
SET time_zone = 'MET';
--let $create_sql = CREATE TABLE t_time_zone (a timestamp, b datetime)
--let $table_name = t_time_zone
--let $insert_sql = INSERT INTO t_time_zone VALUES ('2020-01-01 12:00:00', '1970-01-01 12:00:00')
--let $config_sql = SET time_zone = '+07:00'
--let $select_sql = SELECT * FROM t_time_zone WHERE a < '2020-01-01 18:00:01' and a > '2020-01-01 17:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00'
--let $die_on_error=1
--source suite/duckdb/include/check_field_correctness.inc



SET time_zone='+00:00';
CREATE TABLE t_duckdb (a timestamp, b datetime) ENGINE=duckdb;
CREATE TABLE t_innodb (a timestamp, b datetime) ENGINE=innodb;
INSERT INTO t_duckdb VALUES ('2020-01-01 00:00:00', '1970-01-01 00:00:00');
INSERT INTO t_innodb VALUES ('2020-01-01 00:00:00', '1970-01-01 00:00:00');

SET time_zone='-11:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 13:00:01' and a > '2019-12-31 12:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 13:00:01' and a > '2019-12-31 12:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-10:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 14:00:01' and a > '2019-12-31 13:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 14:00:01' and a > '2019-12-31 13:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-09:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 15:00:01' and a > '2019-12-31 14:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 15:00:01' and a > '2019-12-31 14:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-08:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 16:00:01' and a > '2019-12-31 15:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 16:00:01' and a > '2019-12-31 15:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-07:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 17:00:01' and a > '2019-12-31 16:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 17:00:01' and a > '2019-12-31 16:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-06:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 18:00:01' and a > '2019-12-31 17:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 18:00:01' and a > '2019-12-31 17:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-05:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 19:00:01' and a > '2019-12-31 18:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 19:00:01' and a > '2019-12-31 18:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-04:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 20:00:01' and a > '2019-12-31 19:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 20:00:01' and a > '2019-12-31 19:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-03:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 21:00:01' and a > '2019-12-31 20:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 21:00:01' and a > '2019-12-31 20:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-02:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 22:00:01' and a > '2019-12-31 21:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 22:00:01' and a > '2019-12-31 21:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='-01:00'; SELECT * FROM t_innodb WHERE a < '2019-12-31 23:00:01' and a > '2019-12-31 22:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2019-12-31 23:00:01' and a > '2019-12-31 22:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+00:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 00:00:01' and a > '2019-12-31 23:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 00:00:01' and a > '2019-12-31 23:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+01:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 01:00:01' and a > '2020-01-01 00:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 01:00:01' and a > '2020-01-01 00:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+02:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 02:00:01' and a > '2020-01-01 01:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 02:00:01' and a > '2020-01-01 01:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+03:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 03:00:01' and a > '2020-01-01 02:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 03:00:01' and a > '2020-01-01 02:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+04:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 04:00:01' and a > '2020-01-01 03:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 04:00:01' and a > '2020-01-01 03:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+05:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 05:00:01' and a > '2020-01-01 04:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 05:00:01' and a > '2020-01-01 04:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+06:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 06:00:01' and a > '2020-01-01 05:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 06:00:01' and a > '2020-01-01 05:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+07:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 07:00:01' and a > '2020-01-01 06:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 07:00:01' and a > '2020-01-01 06:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+08:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 08:00:01' and a > '2020-01-01 07:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 08:00:01' and a > '2020-01-01 07:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+09:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 09:00:01' and a > '2020-01-01 08:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 09:00:01' and a > '2020-01-01 08:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+10:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 10:00:01' and a > '2020-01-01 09:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 10:00:01' and a > '2020-01-01 09:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+11:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 11:00:01' and a > '2020-01-01 10:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 11:00:01' and a > '2020-01-01 10:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+12:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 12:00:01' and a > '2020-01-01 11:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 12:00:01' and a > '2020-01-01 11:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+13:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 13:00:01' and a > '2020-01-01 12:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 13:00:01' and a > '2020-01-01 12:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';
SET time_zone='+14:00'; SELECT * FROM t_innodb WHERE a < '2020-01-01 14:00:01' and a > '2020-01-01 13:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';  SELECT * FROM t_duckdb WHERE a < '2020-01-01 14:00:01' and a > '2020-01-01 13:59:59' and b < '1970-01-01 12:00:01' and b > '1969-12-31 23:59:00';

DROP TABLE t_innodb;
DROP TABLE t_duckdb;

SET time_zone=default;