--source include/master-slave.inc
--source include/have_binlog_format_row.inc
--source include/have_debug.inc

--echo ###########################################################################
--echo # 0. Prepare
--echo ###########################################################################
--source include/rpl_connection_master.inc
CREATE TABLE t1 (
    id BIGINT NOT NULL,
    c0 VARCHAR(20) NOT NULL,
    c1 CHAR(10) DEFAULT 'duckdb',
    c2 DECIMAL(5,2),
    c3 DATETIME,
    c4 TIMESTAMP,
    c5 BLOB,
    PRIMARY KEY(id, c0)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t1 ENGINE=DuckDB;
SHOW CREATE TABLE t1;

--echo ###########################################################################
--echo # 1. Test Insert
--echo ###########################################################################
--source include/rpl_connection_master.inc
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES
(1, 'abc', NULL, 1.23, '2020-11-20', NULL, X'e18080ff8a'),
(2, 'd', NULL, NULL, '1998-01-01', '2006-02-28 00:21:11', NULL),
(3, 'efg', 'RSA', 5.2, NULL, '2028-09-09 15:30:34', NULL),
(4, 'hijk', NULL, 6, '2023-06-07', NULL, X'1a53aa890ee6'),
(5, 'lmn', 'RSA', 10.5, NULL, '1988-10-01 08:58:25', NULL);

--echo ###########################################################################
--echo # 2. Test Update
--echo ###########################################################################
--source include/rpl_connection_master.inc
BEGIN;
--echo # Test modify non-PK field
UPDATE t1 SET c1='xxxxx', c2=7.79, c3=NULL, c4='2025-03-25 20:58:23', c5=X'e18080e18080' WHERE id=4;
UPDATE t1 SET c2=8.88 WHERE id=5;
--echo # Test modify PK field
UPDATE t1 SET c0='yyyyyy' WHERE id=3;
UPDATE t1 SET id=6, c4='2026-03-27 10:00:34' WHERE id=1;
COMMIT;

FLUSH LOGS;

--echo ###########################################################################
--echo # 3. Test Delete
--echo ###########################################################################
--source include/rpl_connection_master.inc
BEGIN;
DELETE FROM t1 WHERE id=2;
DELETE FROM t1 WHERE id=5;
COMMIT;

--echo ###########################################################################
--echo # 4. Test Mix Transaction
--echo ###########################################################################
--source include/rpl_connection_master.inc
BEGIN;
DELETE FROM t1 WHERE id=3;
UPDATE t1 SET c1='zzzzzz' WHERE id=1;
INSERT INTO t1 (id, c0, c1, c2, c3, c4, c5) VALUES (3, 'rds', 'RSA', 5.7, NULL, '2028-01-01 10:11:10', NULL);
INSERT INTO t1 (id, c0) VALUES (2, 'hhhhh');
UPDATE t1 SET c0='mysql' WHERE id=4;
DELETE FROM t1 WHERE id=2;
COMMIT;

--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--echo ###########################################################################
--echo # 5. Test binlog_rows_query_log_events = on, Rows_query Event will not commit
--echo #    batch implicitly
--echo ###########################################################################
--source include/rpl_connection_master.inc
SET binlog_rows_query_log_events = on;
UPDATE t1 SET c0='alisql' WHERE id=4;
INSERT INTO t1 (id, c0) VALUES (2, 'dddd');

--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT id, c0, c1, c2, c3, c4, HEX(c5) FROM test.t1 ORDER BY id;
--source include/rpl_diff.inc

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = batch is not committed due to Rows_query Event
--let $assert_select = commit duckdb batch due to non-Row Format
--let $assert_count = 0
--source include/assert_grep.inc

--echo ###########################################################################
--echo # 6. Test transactions are not replayed by executing SQL
--echo ###########################################################################
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check DML SQL is not executed
--let $assert_select = duckdb_print_dml
--let $assert_count = 0
--source include/assert_grep.inc


--echo ###########################################################################
--echo # 7. Test duckdb_commit_multi_trx_due_to_rotate_frequency
--echo ###########################################################################
--source include/rpl_connection_slave.inc

SET GLOBAL duckdb_commit_multi_trx_due_to_reader = OFF;
SET GLOBAL duckdb_multi_trx_timeout = 5000;

--source include/rpl_connection_master.inc
CREATE TABLE t2 (id int primary key auto_increment, c0 varchar(32)) ENGINE=InnoDB;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t2 ENGINE=DuckDB;

--echo # duckdb_commit_multi_trx_due_to_rotate_frequency = 2

--exec echo "" > $MYSQLTEST_VARDIR/log/mysqld.2.err

--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_commit_multi_trx_due_to_rotate_frequency = 2;

--source include/rpl_connection_master.inc
INSERT INTO t2(c0) VALUES ('abc');
flush logs;

INSERT INTO t2(c0) VALUES ('abc');
flush logs;

INSERT INTO t2(c0) VALUES ('abc');
flush logs;

INSERT INTO t2(c0) VALUES ('abc');
flush logs;

INSERT INTO t2(c0) VALUES ('abc');
flush logs;

INSERT INTO t2(c0) VALUES ('abc');
flush logs;

INSERT INTO t2(c0) VALUES ('abc');
flush logs;

# wait duckdb_multi_trx_timeout
INSERT INTO t2(c0) VALUES ('abc');
SELECT SLEEP(6);
INSERT INTO t2(c0) VALUES ('abc');

--source include/rpl_sync.inc

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check multi-trx is committed due to rotate
--let $assert_select = commit duckdb batch due to rotate
--let $assert_count = 3
--source include/assert_grep.inc


--echo # duckdb_commit_multi_trx_due_to_rotate_frequency = 1
--exec echo "" > $MYSQLTEST_VARDIR/log/mysqld.2.err

--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_commit_multi_trx_due_to_rotate_frequency = 1;

--source include/rpl_connection_master.inc

INSERT INTO t2(c0) VALUES ('abc');
flush logs;
INSERT INTO t2(c0) VALUES ('abc');
flush logs;

# wait duckdb_multi_trx_timeout
INSERT INTO t2(c0) VALUES ('abc');
SELECT SLEEP(6);
INSERT INTO t2(c0) VALUES ('abc');


--source include/rpl_sync.inc

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check multi-trx is committed due to rotate
--let $assert_select = commit duckdb batch due to rotate
--let $assert_count = 2
--source include/assert_grep.inc

--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_commit_multi_trx_due_to_reader = default;
SET GLOBAL duckdb_commit_multi_trx_due_to_rotate_frequency = default;
SET GLOBAL duckdb_multi_trx_timeout = default;


--echo ###########################################################################
--echo # 8. Test Cleanup
--echo ###########################################################################

--source include/rpl_connection_master.inc
DROP TABLE t1;
DROP TABLE t2;
--source include/rpl_sync.inc
--source include/rpl_end.inc
