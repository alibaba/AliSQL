include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the connection metadata repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection master]
###########################################################################
# 0. Prepare
###########################################################################
[connection master]
CREATE TABLE t1 (
id BIGINT NOT NULL,
c0 VARCHAR(20) NOT NULL,
c1 CHAR(10) DEFAULT 'duckdb',
PRIMARY KEY(id)
) ENGINE=DuckDB;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` bigint NOT NULL,
  `c0` varchar(20) NOT NULL,
  `c1` char(10) DEFAULT 'duckdb',
  PRIMARY KEY (`id`)
) ENGINE=DUCKDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
include/rpl_sync.inc
[connection slave]
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` bigint NOT NULL,
  `c0` varchar(20) NOT NULL,
  `c1` char(10) DEFAULT 'duckdb',
  PRIMARY KEY (`id`)
) ENGINE=DUCKDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
###########################################################################
# 1. Test Insert-only Transaction
###########################################################################
[connection master]
BEGIN;
INSERT INTO t1 (id, c0, c1) VALUES (1, 'abc', NULL), (2, 'd', NULL);
INSERT INTO t1 (id, c0, c1) VALUES (3, 'efg', 'RSA'), (4, 'hijk', NULL);
INSERT INTO t1 (id, c0, c1) VALUES (5, 'lmn', 'RSA');
COMMIT;
###########################################################################
# 2. Test Update after Insert in a Transaction
###########################################################################
[connection master]
BEGIN;
INSERT INTO t1 (id, c0, c1) VALUES (6, 'zxx', 'bbbbb'), (7, 'zqq', 'pppp');
# Test modify non-PK field
UPDATE t1 SET c1='bee' WHERE id=6;
UPDATE t1 SET c0='opq' WHERE id=5;
# Test modify PK field
UPDATE t1 SET id=8 WHERE id=7;
UPDATE t1 SET id=7 WHERE id=1;
COMMIT;
###########################################################################
# 3. Test Delete after Insert in a Transaction
###########################################################################
[connection master]
BEGIN;
INSERT INTO t1 (id, c0, c1) VALUES (9, 'fff', 'ddd'), (10, 'ddd', 'fff');
DELETE FROM t1 WHERE id=3;
DELETE FROM t1 WHERE id=10;
COMMIT;
###########################################################################
# 4. Test Mix Transaction
###########################################################################
[connection master]
BEGIN;
INSERT INTO t1 (id, c0, c1) VALUES (11, 'dsha', 'hfdu'), (12, 'xbn', 'wety');
DELETE FROM t1 WHERE id=11;
UPDATE t1 SET id=1 WHERE id=2;
INSERT INTO t1 (id, c0, c1) VALUES (11, 'dsha', 'hfdu'), (2, 'uery', NULL);
UPDATE t1 SET c1='zzzzzz' WHERE id=1;
INSERT INTO t1 (id, c0) VALUES (3, 'hhhhh');
COMMIT;
###########################################################################
# 5. Check result
###########################################################################
include/rpl_sync.inc
include/rpl_diff.inc
SELECT id, c0, c1 FROM test.t1 ORDER BY id;
id	c0	c1
1	d	zzzzzz
2	uery	NULL
3	hhhhh	duckdb
4	hijk	NULL
5	opq	RSA
6	zxx	bee
7	abc	NULL
8	zqq	pppp
9	fff	ddd
11	dsha	hfdu
12	xbn	wety
SHOW STATUS LIKE '%duck%in_batch';
Variable_name	Value
Duckdb_rows_insert_in_batch	14
Duckdb_rows_update_in_batch	0
Duckdb_rows_delete_in_batch	0
###########################################################################
# Cleanup
###########################################################################
[connection master]
DROP TABLE t1;
include/rpl_sync.inc
include/rpl_end.inc
