include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the connection metadata repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection master]
###########################################################################
# 0. Prepare
###########################################################################
[connection master]
SET autocommit = 1;
CREATE TABLE t1 (
id BIGINT NOT NULL,
c0 VARCHAR(20) NOT NULL,
c1 CHAR(10) DEFAULT 'duckdb',
PRIMARY KEY(id, c0)
) ENGINE=InnoDB;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` bigint NOT NULL,
  `c0` varchar(20) NOT NULL,
  `c1` char(10) DEFAULT 'duckdb',
  PRIMARY KEY (`id`,`c0`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
include/rpl_sync.inc
[connection slave]
ALTER TABLE t1 ENGINE=DuckDB;
CALL dbms_duckdb.query("ALTER TABLE test.t1 ADD PRIMARY KEY (id, c0)");
RESULT
Success	
BOOLEAN	
[ Rows: 0]


SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` bigint NOT NULL,
  `c0` varchar(20) NOT NULL,
  `c1` char(10) DEFAULT 'duckdb',
  PRIMARY KEY (`id`,`c0`)
) ENGINE=DUCKDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
###########################################################################
# 1. Test Slave SQL Thread encountered an error during commit
###########################################################################
# 1.1 Stop Purge in DuckDB
[connection slave1]
BEGIN;
INSERT INTO t1 VALUES(7, 'xxxx', 'stop purge');
# 1.2 Let DuckDB have two versions of Row 1
[connection master]
INSERT INTO t1 (id, c0, c1) VALUES (1, 'abc', NULL);
FLUSH LOGS;
UPDATE t1 SET c1='AliSQL' WHERE id=1;
FLUSH LOGS;
# 1.3 DuckDB fails when committing version 3 of Row 1
include/rpl_sync.inc
[connection slave]
STOP REPLICA;
[connection master]
UPDATE t1 SET c1='DuckDB' WHERE id=1;
FLUSH LOGS;
[connection slave]
CALL mtr.add_suppression("MY-010584");
CALL mtr.add_suppression("MY-010583");
START REPLICA;
include/wait_for_slave_sql_to_stop.inc
# 1.4 Resume Purge in DuckDB
[connection slave1]
ROLLBACK;
# 1.5 Check the result
[connection slave]
START REPLICA;
include/rpl_sync.inc
include/rpl_diff.inc
###########################################################################
# 2. Cleanup
###########################################################################
[connection master]
DROP TABLE t1;
include/rpl_sync.inc
include/rpl_end.inc
