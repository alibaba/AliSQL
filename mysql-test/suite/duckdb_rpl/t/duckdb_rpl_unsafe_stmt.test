--source include/master-slave.inc

CREATE TABLE t_duckdb1 (c1 INT PRIMARY KEY, c2 FLOAT) ENGINE = DuckDB;
CREATE TABLE t_duckdb2 (c1 INT PRIMARY KEY, c2 FLOAT) ENGINE = DuckDB;
CREATE TABLE t_innodb1 (c1 INT PRIMARY KEY, c2 FLOAT) ENGINE = InnoDB;
CREATE TABLE t_innodb2 (c1 INT PRIMARY KEY, c2 FLOAT) ENGINE = InnoDB;

INSERT INTO t_duckdb1 VALUES(1, 0.1), (2, 0.1), (3, 0.1);
INSERT INTO t_duckdb2 VALUES(1, 0.1), (2, 0.1), (3, 0.1);
INSERT INTO t_innodb1 VALUES(1, 0.1), (2, 0.1), (3, 0.1);
INSERT INTO t_innodb2 VALUES(1, 0.1), (2, 0.1), (3, 0.1);

--echo #
--echo # Unsafe INSERT should be binlogged in row format
--echo #
--let $binlog_file = query_get_value(SHOW MASTER STATUS, File, 1)
--let $binlog_start = query_get_value(SHOW MASTER STATUS, Position, 1)
INSERT INTO t_duckdb1 VALUES(4, rand());
INSERT INTO t_innodb1 VALUES(4, rand());

--error ER_DUCKDB_CLIENT
REPLACE INTO t_duckdb1 VALUES(5, rand());

REPLACE INTO t_innodb1 VALUES(5, rand());

--source include/show_binlog_events.inc
--let $rpl_diff_statement= SELECT * FROM t_duckdb1 ORDER BY c1
--source include/rpl_diff.inc

--echo #
--echo # Unsafe INSERT ... SELECT should not be binlogged in row format
--echo #
--let $binlog_start = query_get_value(SHOW MASTER STATUS, Position, 1)
INSERT INTO t_duckdb1 SELECT 6, c2 FROM t_duckdb1 WHERE c1 = 1 LIMIT 1;
INSERT INTO t_innodb1 SELECT 6, c2 FROM t_innodb1 WHERE c1 = 1 LIMIT 1;

INSERT INTO t_duckdb1 SELECT 7, c2 FROM t_innodb1 WHERE c1 = 1 LIMIT 1;
--error ER_DUCKDB_CLIENT
INSERT INTO t_innodb1 SELECT * FROM t_duckdb1 WHERE c1 = 1 LIMIT 1;

--error ER_DUCKDB_CLIENT
REPLACE INTO t_duckdb1 SELECT 8, c2 FROM t_duckdb1 WHERE c1 = 1 LIMIT 1;
REPLACE INTO t_innodb1 SELECT 8, c2 FROM t_innodb1 WHERE c1 = 1 LIMIT 1;

# It crashs the server now, it should be uncommented after the crash is fixed.
# REPLACE INTO t_innodb1 SELECT * FROM t_duckdb1 WHERE c1 = 1 LIMIT 1;

--source include/show_binlog_events.inc
--let $rpl_diff_statement= SELECT * FROM t_innodb1 ORDER BY c1
--source include/rpl_diff.inc

--echo #
--echo # Unsafe statment of UPDATE should not be changed to row format
--echo #
--let $binlog_start = query_get_value(SHOW MASTER STATUS, Position, 1)
UPDATE t_duckdb1 SET c2 = 0.2 WHERE c1 = (SELECT 1 LIMIT 1);
UPDATE t_innodb1 SET c2 = 0.2 WHERE c1 = (SELECT 1 LIMIT 1);

--error ER_DUCKDB_CLIENT
UPDATE t_duckdb1, t_duckdb2 SET t_duckdb1.c2 = 0.2, t_duckdb2.c2 = 0.2
  WHERE t_duckdb1.c1 = (SELECT 2 LIMIT 1) AND t_duckdb2.c1 = 2;
UPDATE t_innodb1, t_innodb2 SET t_innodb1.c2 = 0.2, t_innodb2.c2 = 0.2
  WHERE t_innodb1.c1 = (SELECT 2 LIMIT 1) AND t_innodb2.c1 = 2;

--error ER_DUCKDB_CLIENT
UPDATE t_duckdb1, t_innodb1 SET t_duckdb1.c2 = 0.2, t_innodb1.c2 = 0.2
  WHERE t_duckdb1.c1 = (SELECT 3 LIMIT 1) AND t_innodb1.c1 = 3;

--source include/show_binlog_events.inc
--let $rpl_diff_statement= SELECT * FROM t_duckdb1 ORDER BY c1
--source include/rpl_diff.inc


--echo #
--echo # Unsafe statment of DELETE should not be changed to row format
--echo #
--let $binlog_start = query_get_value(SHOW MASTER STATUS, Position, 1)
DELETE FROM t_duckdb1 WHERE c1 = (SELECT 1 LIMIT 1);
DELETE FROM t_innodb1 WHERE c1 = (SELECT 1 LIMIT 1);

--error ER_DUCKDB_CLIENT
DELETE t_duckdb1, t_duckdb2 FROM t_duckdb1, t_duckdb2
  WHERE t_duckdb1.c1 = 2 AND t_duckdb2.c1 = (SELECT 2 LIMIT 1);
DELETE t_innodb1, t_innodb2 FROM t_innodb1, t_innodb2
  WHERE t_innodb1.c1 = 2 AND t_innodb2.c1 = (SELECT 2 LIMIT 1);

--source include/show_binlog_events.inc
--let $rpl_diff_statement= SELECT * FROM t_duckdb1 ORDER BY c1
--source include/rpl_diff.inc

DROP TABLE t_duckdb1, t_innodb1, t_duckdb2, t_innodb2;
--source include/rpl_end.inc
