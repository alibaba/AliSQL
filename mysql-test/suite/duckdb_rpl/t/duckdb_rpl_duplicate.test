--source include/master-slave.inc

--echo ###########################################################################
--echo # Prepare, DuckDB (master) -> DuckDB (slave)
--echo ###########################################################################
CREATE TABLE t_duckdb (c1 VARCHAR(10) PRIMARY KEY, c2 INT) ENGINE = DuckDB;
FLUSH LOGS;

INSERT INTO t_duckdb VALUES(x'61626364', 1);

--echo ###########################################################################
--echo # 1. Switch on 'duckdb_data_import_mode'
--echo ###########################################################################
SET duckdb_data_import_mode=on;

BEGIN;
DELETE FROM t_duckdb WHERE c1 = x'61626364';
INSERT INTO t_duckdb VALUES(x'61626364', 2);
COMMIT;

--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT c1, c2 FROM t_duckdb ORDER BY c1;
--source include/rpl_diff.inc

SELECT * FROM t_duckdb;

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check Delete SQL is not executed
--let $assert_select = DELETE FROM t_duckdb .*
--let $assert_count = 0
--source include/assert_grep.inc

--echo ###########################################################################
--echo # 2. Switch off 'duckdb_data_import_mode'
--echo ###########################################################################
SET duckdb_data_import_mode=off;

BEGIN;
DELETE FROM t_duckdb WHERE c1 = x'61626364';
INSERT INTO t_duckdb VALUES(x'61626364', 3);
COMMIT;

--source include/rpl_sync.inc
--let $rpl_diff_statement = SELECT c1, c2 FROM t_duckdb ORDER BY c1;
--source include/rpl_diff.inc

SELECT * FROM t_duckdb;

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Check Delete SQL is executed
--let $assert_select = DELETE FROM t_duckdb .*
--let $assert_count = 1
--source include/assert_grep.inc

--echo ###########################################################################
--echo # 3. Test for duckdb_idempotent_data_import_enabled
--echo ###########################################################################
--exec echo "" > $MYSQLTEST_VARDIR/log/mysqld.1.err
--exec echo "" > $MYSQLTEST_VARDIR/log/mysqld.2.err

--source include/rpl_connection_master.inc
SET GLOBAL duckdb_idempotent_data_import_enabled = ON;
--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_idempotent_data_import_enabled = ON;

--source include/rpl_connection_master.inc
SET duckdb_data_import_mode = on;
BEGIN;
INSERT INTO t_duckdb VALUES(x'61626365', 4);
COMMIT;
# simulate restart and re-insert, only one row will be inserted finally.
BEGIN;
INSERT INTO t_duckdb VALUES(x'61626365', 4);
COMMIT;

--source include/rpl_sync.inc
SELECT * FROM t_duckdb;
--source include/rpl_connection_slave.inc
SELECT * FROM t_duckdb;

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.1.err
--let $assert_text = Find delete action in log
--let $assert_select = DELETE FROM `test`.`t_duckdb`
--let $assert_count = 2
--source include/assert_grep.inc

--let $assert_text = Find insert action in log
--let $assert_select = INSERT INTO `test`.`t_duckdb`
--let $assert_count = 2
--source include/assert_grep.inc

--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Find delete action in log
--let $assert_select = DELETE FROM `test`.`t_duckdb`
--let $assert_count = 2
--source include/assert_grep.inc

--let $assert_text = Find insert action in log
--let $assert_select = INSERT INTO `test`.`t_duckdb`
--let $assert_count = 2
--source include/assert_grep.inc


--echo ###########################################################################
--echo # Cleanup
--echo ###########################################################################
--source include/rpl_connection_master.inc
SET GLOBAL duckdb_idempotent_data_import_enabled = default;
--source include/rpl_connection_slave.inc
SET GLOBAL duckdb_idempotent_data_import_enabled = default;
--source include/rpl_connection_master.inc
DROP TABLE t_duckdb;
--source include/rpl_end.inc
