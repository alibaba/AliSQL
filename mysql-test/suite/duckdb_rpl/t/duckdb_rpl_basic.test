--source include/have_debug_sync.inc
--source include/have_binlog_format_mixed.inc
--source include/master-slave.inc

--echo #
--echo # Init
--echo #
CREATE TABLE t1(c1 INT PRIMARY KEY, c2 VARCHAR(100)) ENGINE = DuckDB;

--let $master_uuid = `SELECT @@global.server_uuid`
--source include/rpl_sync.inc

--source include/rpl_connection_slave.inc
--let $status_items = Retrieved_Gtid_Set
--let $slave_field_result_replace = /$master_uuid/MASTER_UUID/
--source include/show_slave_status.inc

--echo #
--echo # Verify the binlog generated by current trx should not be replicated
--echo # to slave until it is committed.
--echo #
--source include/rpl_connection_master.inc
--let $binlog_file = query_get_value("SHOW MASTER STATUS", File, 1)
--let $binlog_position = query_get_value("SHOW MASTER STATUS", Position, 1)

# hang the INSERT after binary events are written to binlog file.
SET debug_sync = "after_binlog_sync SIGNAL binlog_flushed WAIT_FOR continue";
--send INSERT INTO t1 VALUES(1, "master")

--source include/rpl_connection_master1.inc
SET debug_sync = "now WAIT_FOR binlog_flushed";
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.gtid_executed;

--echo # mysqlbinlog can see the events.
--let $MYSQLD_DATADIR = `select @@datadir`
--let $binlog_fullpath = $MYSQLD_DATADIR/$binlog_file
--let $mysqlbinlog_parameters= --short-form
--source include/mysqlbinlog.inc

--source include/rpl_connection_slave.inc
--sleep 1

--let $status_items=Retrieved_Gtid_Set
--let $slave_field_result_replace = /$master_uuid/MASTER_UUID/
--source include/show_slave_status.inc
SELECT * FROM t1 ORDER BY c1;

--source include/rpl_connection_master1.inc
SET debug_sync = "now SIGNAL continue";

--source include/rpl_connection_master.inc
--reap
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.gtid_executed;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--let $status_items=Retrieved_Gtid_Set
--let $slave_field_result_replace = /$master_uuid/MASTER_UUID/
--source include/show_slave_status.inc

--echo #
--echo # Test there is no snapshot conflict on duckdb_binlog_position
--echo # trx1 is start earlier than trx2, but trx2 is committed before
--echo # trx1. It should works well.
--echo #
--source include/rpl_connection_master.inc
# Trx1 with earlier snapshot version
BEGIN;
INSERT INTO t1 VALUES(2, "2");

--source include/rpl_connection_master1.inc
# Trx1 with later snapshot version
INSERT INTO t1 VALUES(3, "3");

--source include/rpl_connection_master.inc
COMMIT;
SELECT * FROM t1;

--echo #
--echo # Rows events generated by master can be applied by slave which mixed mode
--echo #
--source include/rpl_connection_master.inc
SET binlog_format = row;
CREATE TABLE t2 (c1 INT PRIMARY KEY, c2 VARCHAR(100)) ENGINE = InnoDB;
--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
ALTER TABLE t2 ENGINE = DuckDB;

--source include/rpl_connection_master.inc
INSERT INTO t2 VALUES(1, "master"), (2, "master"), (3, "master");
UPDATE t2 SET c2 = "slave";
DELETE FROM t2 WHERE c1 = 2;

FLUSH BINARY LOGS;

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
SELECT * FROM t2 ORDER BY c1;
FLUSH BINARY LOGS;
--disable_warnings
SET binlog_format = mixed;
--enable_warnings

--echo #
--echo # DDL does nothing can be logged and applied as expected.
--echo #
--source include/rpl_connection_master.inc
DROP DATABASE IF EXISTS db1;
DROP TABLE IF EXISTS db1.t1;
CREATE TABLE IF NOT EXISTS t2(c1 INT) ENGINE=DuckDB;

--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.gtid_executed;

--let $binlog_file = query_get_value(SHOW MASTER STATUS, File, 1)
--source include/show_binlog_events.inc

--source include/rpl_sync.inc
--source include/rpl_connection_slave.inc
--let $slave_uuid = `SELECT @@server_uuid`
--replace_result $master_uuid MASTER_UUID $slave_uuid SLAVE_UUID
SELECT @@GLOBAL.gtid_executed;

--let $binlog_file = query_get_value(SHOW MASTER STATUS, File, 1)
--source include/show_binlog_events.inc

--echo #
--echo # Cleanup
--echo #
--source include/rpl_connection_master.inc
DROP TABLE t1, t2;
--source include/rpl_end.inc
