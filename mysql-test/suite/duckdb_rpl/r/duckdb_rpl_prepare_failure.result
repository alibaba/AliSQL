include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the connection metadata repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection master]
#
# Init
#
CREATE TABLE t1(c1 INT NOT NULL PRIMARY KEY, c2 VARCHAR(200)) ENGINE = DUCKDB;
call dbms_duckdb.query("DROP TABLE test.t1");
RESULT
Success	
BOOLEAN	
[ Rows: 0]


call dbms_duckdb.query("CREATE TABLE test.t1(c1 INT NOT NULL PRIMARY KEY, c2 VARCHAR(200))");
RESULT
Count	
BIGINT	
[ Rows: 0]


include/rpl_sync.inc
[connection slave]
call dbms_duckdb.query("DROP TABLE test.t1");
RESULT
Success	
BOOLEAN	
[ Rows: 0]


call dbms_duckdb.query("CREATE TABLE test.t1(c1 INT NOT NULL PRIMARY KEY, c2 VARCHAR(200))");
RESULT
Count	
BIGINT	
[ Rows: 0]


[connection master]
INSERT INTO t1 VALUES(1, "1"), (2, "2"), (3, "3");
#
# Use a single INSERT transaction to trigger duplicate key error at
# prepare
#
INSERT INTO t1 VALUES(3, "duplicate key");
ERROR HY000: [DuckDB] DuckDB prepare transaction error. Duplicate key "c1: 3" violates primary key constraint.
SELECT * FROM t1 ORDER BY c1;
c1	c2
1	1
2	2
3	3
INSERT INTO t1 VALUES(4, "4");
SHOW BINLOG EVENTS IN 'master-bin.000001';
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000001	4	Format_desc	#	126	Server ver: #.#.#
master-bin.000001	126	Previous_gtids	#	157	
master-bin.000001	157	Gtid	#	234	SET @@SESSION.GTID_NEXT= 'SERVER_UUID:1'
master-bin.000001	234	Query	#	399	use `test`; CREATE TABLE t1(c1 INT NOT NULL PRIMARY KEY, c2 VARCHAR(200)) ENGINE = DUCKDB /* xid=# */
master-bin.000001	399	Gtid	#	478	SET @@SESSION.GTID_NEXT= 'SERVER_UUID:2'
master-bin.000001	478	Query	#	560	BEGIN
master-bin.000001	560	Query	#	686	use `test`; INSERT INTO t1 VALUES(1, "1"), (2, "2"), (3, "3")
master-bin.000001	686	Xid	#	717	COMMIT /* xid=# */
master-bin.000001	717	Gtid	#	796	SET @@SESSION.GTID_NEXT= 'SERVER_UUID:3'
master-bin.000001	796	Query	#	878	BEGIN
master-bin.000001	878	Query	#	984	use `test`; INSERT INTO t1 VALUES(4, "4")
master-bin.000001	984	Xid	#	1015	COMMIT /* xid=# */
include/rpl_diff.inc
#
# Same to above test but the INSERT in a multiple statement transaction.
# COMMIT will trigger the duplicate key error.
#
[connection master]
BEGIN;
UPDATE t1 SET c2 = "test";
INSERT INTO t1 VALUES(4, "duplicate key");
SELECT * FROM t1 ORDER BY c1;
c1	c2
1	test
2	test
3	test
4	test
COMMIT;
ERROR HY000: [DuckDB] DuckDB prepare transaction error. Duplicate key "c1: 4" violates primary key constraint.
SELECT * FROM t1 ORDER BY c1;
c1	c2
1	1
2	2
3	3
4	4
SHOW BINLOG EVENTS IN 'master-bin.000001';
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000001	4	Format_desc	#	126	Server ver: #.#.#
master-bin.000001	126	Previous_gtids	#	157	
master-bin.000001	157	Gtid	#	234	SET @@SESSION.GTID_NEXT= 'SERVER_UUID:1'
master-bin.000001	234	Query	#	399	use `test`; CREATE TABLE t1(c1 INT NOT NULL PRIMARY KEY, c2 VARCHAR(200)) ENGINE = DUCKDB /* xid=# */
master-bin.000001	399	Gtid	#	478	SET @@SESSION.GTID_NEXT= 'SERVER_UUID:2'
master-bin.000001	478	Query	#	560	BEGIN
master-bin.000001	560	Query	#	686	use `test`; INSERT INTO t1 VALUES(1, "1"), (2, "2"), (3, "3")
master-bin.000001	686	Xid	#	717	COMMIT /* xid=# */
master-bin.000001	717	Gtid	#	796	SET @@SESSION.GTID_NEXT= 'SERVER_UUID:3'
master-bin.000001	796	Query	#	878	BEGIN
master-bin.000001	878	Query	#	984	use `test`; INSERT INTO t1 VALUES(4, "4")
master-bin.000001	984	Xid	#	1015	COMMIT /* xid=# */
include/rpl_diff.inc
[connection master]
FLUSH BINARY LOGS;
INSERT INTO t1 VALUES(6, "6");
SELECT * FROM t1 ORDER BY c1;
c1	c2
1	1
2	2
3	3
4	4
6	6
SHOW BINLOG EVENTS IN 'master-bin.000002';
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000002	4	Format_desc	#	126	Server ver: #.#.#
master-bin.000002	126	Previous_gtids	#	197	SERVER_UUID:1-3
master-bin.000002	197	Gtid	#	276	SET @@SESSION.GTID_NEXT= 'SERVER_UUID:4'
master-bin.000002	276	Query	#	358	BEGIN
master-bin.000002	358	Query	#	464	use `test`; INSERT INTO t1 VALUES(6, "6")
master-bin.000002	464	Xid	#	495	COMMIT /* xid=# */
#
# Cleanup
#
DROP TABLE t1;
include/rpl_end.inc
