include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the connection metadata repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection master]
#
# Init
#
CREATE TABLE t1(c1 INT PRIMARY KEY, c2 VARCHAR(100)) ENGINE = DuckDB;
include/rpl_sync.inc
[connection slave]
Retrieved_Gtid_Set = 'MASTER_UUID:1'
#
# Verify the binlog generated by current trx should not be replicated
# to slave until it is committed.
#
[connection master]
SET debug_sync = "after_binlog_sync SIGNAL binlog_flushed WAIT_FOR continue";
INSERT INTO t1 VALUES(1, "master");
[connection master1]
SET debug_sync = "now WAIT_FOR binlog_flushed";
SELECT @@GLOBAL.gtid_executed;
@@GLOBAL.gtid_executed
MASTER_UUID:1
# mysqlbinlog can see the events.
include/mysqlbinlog.inc
# The proper term is pseudo_replica_mode, but we use this compatibility alias
# to make the statement usable on server versions 8.0.24 and older.
/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;
/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;
DELIMITER /*!*/;
ROLLBACK/*!*/;
# original_commit_timestamp= MICROSECONDS-FROM-EPOCH (YYYY-MM-DD HOURS:MINUTES:SECONDS TZ)
# immediate_commit_timestamp= MICROSECONDS-FROM-EPOCH (YYYY-MM-DD HOURS:MINUTES:SECONDS TZ)
/*!80001 SET @@session.original_commit_timestamp= MICROSECONDS-FROM-EPOCH*//*!*/;
/*!80014 SET @@session.original_server_version= ORIGINAL_SERVER_VERSION*//*!*/;
/*!80014 SET @@session.immediate_server_version= IMMEDIATE_SERVER_VERSION*//*!*/;
SET @@SESSION.GTID_NEXT= '#'/*!*/;
SET TIMESTAMP=#/*!*/;
SET @@session.pseudo_thread_id=#/*!*/;
SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;
SET @@session.sql_mode=1168113696/*!*/;
SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;
/*!\C utf8mb4 *//*!*/;
SET @@session.character_set_client=255,@@session.collation_connection=255,@@session.collation_server=255/*!*/;
SET @@session.lc_time_names=0/*!*/;
SET @@session.collation_database=DEFAULT/*!*/;
/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/;
BEGIN
/*!*/;
use `test`/*!*/;
SET TIMESTAMP=#/*!*/;
INSERT INTO t1 VALUES(1, "master")
/*!*/;
COMMIT/*!*/;
SET @@SESSION.GTID_NEXT= '#' /* added by mysqlbinlog */ /*!*/;
DELIMITER ;
# End of log file
/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;
/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;
[connection slave]
Retrieved_Gtid_Set = 'MASTER_UUID:1'
SELECT * FROM t1 ORDER BY c1;
c1	c2
[connection master1]
SET debug_sync = "now SIGNAL continue";
[connection master]
SELECT @@GLOBAL.gtid_executed;
@@GLOBAL.gtid_executed
MASTER_UUID:1-2
include/rpl_sync.inc
[connection slave]
Retrieved_Gtid_Set = 'MASTER_UUID:1-2'
#
# Test there is no snapshot conflict on duckdb_binlog_position
# trx1 is start earlier than trx2, but trx2 is committed before
# trx1. It should works well.
#
[connection master]
BEGIN;
INSERT INTO t1 VALUES(2, "2");
[connection master1]
INSERT INTO t1 VALUES(3, "3");
[connection master]
COMMIT;
SELECT * FROM t1;
c1	c2
1	master
3	3
2	2
#
# Rows events generated by master can be applied by slave which mixed mode
#
[connection master]
SET binlog_format = row;
Warnings:
Warning	1287	'@@binlog_format' is deprecated and will be removed in a future release.
CREATE TABLE t2 (c1 INT PRIMARY KEY, c2 VARCHAR(100)) ENGINE = InnoDB;
include/rpl_sync.inc
[connection slave]
ALTER TABLE t2 ENGINE = DuckDB;
[connection master]
INSERT INTO t2 VALUES(1, "master"), (2, "master"), (3, "master");
UPDATE t2 SET c2 = "slave";
DELETE FROM t2 WHERE c1 = 2;
FLUSH BINARY LOGS;
include/rpl_sync.inc
[connection slave]
SELECT * FROM t2 ORDER BY c1;
c1	c2
1	slave
3	slave
FLUSH BINARY LOGS;
SET binlog_format = mixed;
#
# DDL does nothing can be logged and applied as expected.
#
[connection master]
DROP DATABASE IF EXISTS db1;
Warnings:
Note	1008	Can't drop database 'db1'; database doesn't exist
DROP TABLE IF EXISTS db1.t1;
Warnings:
Note	1051	Unknown table 'db1.t1'
CREATE TABLE IF NOT EXISTS t2(c1 INT) ENGINE=DuckDB;
Warnings:
Note	1050	Table 't2' already exists
SELECT @@GLOBAL.gtid_executed;
@@GLOBAL.gtid_executed
MASTER_UUID:1-11
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000002	#	Query	#	#	DROP DATABASE IF EXISTS db1
master-bin.000002	#	Query	#	#	use `test`; DROP TABLE IF EXISTS `db1`.`t1` /* generated by server */
master-bin.000002	#	Query	#	#	use `test`; CREATE TABLE IF NOT EXISTS t2(c1 INT) ENGINE=DuckDB
include/rpl_sync.inc
[connection slave]
SELECT @@GLOBAL.gtid_executed;
@@GLOBAL.gtid_executed
MASTER_UUID:1-11,
SLAVE_UUID:1
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-bin.000002	#	Query	#	#	DROP DATABASE IF EXISTS db1
slave-bin.000002	#	Query	#	#	use `test`; DROP TABLE IF EXISTS `db1`.`t1` /* generated by server */
slave-bin.000002	#	Query	#	#	use `test`; CREATE TABLE IF NOT EXISTS t2(c1 INT) ENGINE=DuckDB
#
# Cleanup
#
[connection master]
DROP TABLE t1, t2;
include/rpl_end.inc
